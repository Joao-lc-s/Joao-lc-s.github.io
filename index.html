<!DOCTYPE html>
<html lang="pt-BR" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FlowTask">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%236366f1' rx='60'/%3E%3Cpath d='M45 90L90 112.5L135 90L90 67.5L45 90Z' fill='white' stroke='white' stroke-width='4'/%3E%3Cpath d='M45 110L90 132.5L135 110' stroke='white' stroke-width='8' fill='none'/%3E%3C/svg%3E">
    
    <title>FlowTask</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: {
                        brand: {
                            50: 'rgb(var(--color-brand-50) / <alpha-value>)',
                            100: 'rgb(var(--color-brand-100) / <alpha-value>)',
                            500: 'rgb(var(--color-brand-500) / <alpha-value>)',
                            600: 'rgb(var(--color-brand-600) / <alpha-value>)',
                            700: 'rgb(var(--color-brand-700) / <alpha-value>)',
                        },
                        dark: { 
                            800: '#1e293b', 
                            900: '#0f172a'
                        }
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0,0,0,0.08)',
                        'glow': '0 0 20px rgb(var(--color-brand-500) / 0.3)',
                        'inner-light': 'inset 0 2px 4px 0 rgba(255, 255, 255, 0.3)',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1)',
                        'scale-in': 'scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        scaleIn: { '0%': { opacity: '0', transform: 'scale(0.9)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --color-brand-50: 238 242 255;
            --color-brand-100: 224 231 255;
            --color-brand-500: 99 102 241;
            --color-brand-600: 79 70 229;
            --color-brand-700: 67 56 202;
            --bg-solid: #f8fafc;
            --ui-radius: 1.5rem; /* Super rounded */
        }

        .dark :root { --bg-solid: #0f172a; }

        body { 
            transition: background-color 0.5s cubic-bezier(0.4, 0, 0.2, 1); 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none;
            background-color: var(--bg-solid);
            background-image: radial-gradient(at 0% 0%, rgba(var(--color-brand-500), 0.15) 0px, transparent 50%),
                              radial-gradient(at 100% 100%, rgba(236, 72, 153, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
        }
        
        .rounded-dynamic { border-radius: var(--ui-radius) !important; }
        
        /* Modern Glass Effect */
        .glass { 
            background: rgba(255, 255, 255, 0.7); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        .dark .glass { 
            background: rgba(15, 23, 42, 0.6); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        /* Interactive Elements */
        .btn-hover { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .btn-hover:hover { transform: translateY(-2px) scale(1.02); }
        .btn-hover:active { transform: translateY(0) scale(0.96); }

        /* Modern Card */
        .modern-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 1.2rem;
            border: 1px solid rgba(255,255,255,0.8);
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            transition: all 0.3s ease;
        }
        .dark .modern-card {
            background: rgba(30, 41, 59, 0.6);
            border-color: rgba(255,255,255,0.05);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .modern-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 30px -5px rgba(0,0,0,0.1);
        }

        /* Inputs */
        .form-input-modern {
            height: 48px;
            background: rgba(255,255,255,0.5);
            border: 2px solid transparent;
            border-radius: 1rem;
            transition: all 0.3s ease;
        }
        .form-input-modern:focus {
            background: #fff;
            border-color: rgb(var(--color-brand-500));
            box-shadow: 0 0 0 4px rgba(var(--color-brand-500), 0.1);
        }
        .dark .form-input-modern {
            background: rgba(30, 41, 59, 0.5);
            color: white;
        }
        .dark .form-input-modern:focus {
            background: rgba(30, 41, 59, 1);
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.5); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.8); }

        /* Timer */
        .progress-ring__circle { transition: stroke-dashoffset 0.5s ease-in-out; transform: rotate(-90deg); transform-origin: 50% 50%; }
        
        /* Sidebars */
        #settings-sidebar, #scratchpad-sidebar { 
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 2rem 0 0 2rem;
        }
        #scratchpad-sidebar { border-radius: 0 2rem 2rem 0; }
        .closed { transform: translateX(120%); }
        #scratchpad-sidebar.closed { transform: translateX(-120%); }

        /* Pin Dots */
        .pin-dot { width: 16px; height: 16px; background: #e2e8f0; border-radius: 50%; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .dark .pin-dot { background: #334155; }
        .pin-dot.filled { background: rgb(var(--color-brand-500)); transform: scale(1.2); box-shadow: 0 0 15px rgba(var(--color-brand-500), 0.4); }
        
        /* Priority Gradients */
        .bg-gradient-low { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .bg-gradient-med { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .bg-gradient-high { background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%); }
        
        /* Smooth Text Rendering */
        * { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    </style>
</head>
<body class="text-slate-800 dark:text-slate-100 min-h-screen selection:bg-brand-500/30 selection:text-brand-600 overflow-hidden pt-[env(safe-area-inset-top)]">
    
    <!-- PIN Screen -->
    <div id="pin-screen" class="fixed inset-0 flex flex-col items-center justify-center hidden bg-white/80 dark:bg-slate-950/80 backdrop-blur-xl z-[100]">
        <div class="flex-1 flex flex-col items-center justify-center w-full max-w-xs animate-scale-in">
            <div class="mb-10 flex flex-col items-center">
                <div class="w-20 h-20 bg-gradient-to-tr from-brand-500 to-purple-500 rounded-[2rem] shadow-glow flex items-center justify-center mb-6 text-white transform rotate-3">
                    <i data-lucide="lock" class="w-8 h-8"></i>
                </div>
                <h2 class="text-2xl font-bold tracking-tight">Bem-vindo de volta</h2>
                <p class="text-slate-500 text-sm mt-2">Digite seu PIN de acesso</p>
            </div>
            <div class="flex gap-6 mb-12" id="pin-dots">
                <div class="pin-dot" id="dot-0"></div>
                <div class="pin-dot" id="dot-1"></div>
                <div class="pin-dot" id="dot-2"></div>
                <div class="pin-dot" id="dot-3"></div>
            </div>
            <div class="grid grid-cols-3 gap-x-8 gap-y-6 w-full px-4">
                <div class="h-16 rounded-full hover:bg-slate-100 dark:hover:bg-white/10 flex items-center justify-center text-2xl font-medium transition-all cursor-pointer select-none active:scale-90" onclick="pinPress(1)">1</div>
                <div class="h-16 rounded-full hover:bg-slate-100 dark:hover:bg-white/10 flex items-center justify-center text-2xl font-medium transition-all cursor-pointer select-none active:scale-90" onclick="pinPress(2)">2</div>
                <div class="h-16 rounded-full hover:bg-slate-100 dark:hover:bg-white/10 flex items-center justify-center text-2xl font-medium transition-all cursor-pointer select-none active:scale-90" onclick="pinPress(3)">3</div>
                <div class="h-16 rounded-full hover:bg-slate-100 dark:hover:bg-white/10 flex items-center justify-center text-2xl font-medium transition-all cursor-pointer select-none active:scale-90" onclick="pinPress(4)">4</div>
                <div class="h-16 rounded-full hover:bg-slate-100 dark:hover:bg-white/10 flex items-center justify-center text-2xl font-medium transition-all cursor-pointer select-none active:scale-90" onclick="pinPress(5)">5</div>
                <div class="h-16 rounded-full hover:bg-slate-100 dark:hover:bg-white/10 flex items-center justify-center text-2xl font-medium transition-all cursor-pointer select-none active:scale-90" onclick="pinPress(6)">6</div>
                <div class="h-16 rounded-full hover:bg-slate-100 dark:hover:bg-white/10 flex items-center justify-center text-2xl font-medium transition-all cursor-pointer select-none active:scale-90" onclick="pinPress(7)">7</div>
                <div class="h-16 rounded-full hover:bg-slate-100 dark:hover:bg-white/10 flex items-center justify-center text-2xl font-medium transition-all cursor-pointer select-none active:scale-90" onclick="pinPress(8)">8</div>
                <div class="h-16 rounded-full hover:bg-slate-100 dark:hover:bg-white/10 flex items-center justify-center text-2xl font-medium transition-all cursor-pointer select-none active:scale-90" onclick="pinPress(9)">9</div>
                <div class="h-16 opacity-0"></div> 
                <div class="h-16 rounded-full hover:bg-slate-100 dark:hover:bg-white/10 flex items-center justify-center text-2xl font-medium transition-all cursor-pointer select-none active:scale-90" onclick="pinPress(0)">0</div>
                <div class="h-16 rounded-full hover:bg-rose-50 dark:hover:bg-rose-900/20 flex items-center justify-center text-rose-500 transition-all cursor-pointer select-none active:scale-90" onclick="pinDelete()"><i data-lucide="delete" class="w-6 h-6"></i></div>
            </div>
        </div>
    </div>

    <div id="offline-indicator" class="fixed top-6 left-1/2 -translate-x-1/2 bg-rose-500 text-white text-xs font-bold px-4 py-2 rounded-full shadow-lg z-[100] hidden flex items-center gap-2"><i data-lucide="wifi-off" class="w-3 h-3"></i> Sem conexão</div>

    <!-- Modern Toast -->
    <div id="undo-toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-[100] glass px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-4 hidden transform transition-all duration-500 translate-y-10 opacity-0" style="background: rgba(15, 23, 42, 0.95); border: none; color: white;">
        <div class="w-6 h-6 rounded-full bg-green-500 flex items-center justify-center"><i data-lucide="check" class="w-3 h-3 text-white"></i></div>
        <span class="text-sm font-medium">Ação realizada com sucesso</span>
        <button onclick="performUndo()" class="ml-2 text-xs font-bold text-brand-400 hover:text-white transition-colors bg-white/10 px-3 py-1.5 rounded-lg hover:bg-white/20">Desfazer</button>
    </div>

    <!-- MAIN APP LAYOUT -->
    <div class="relative z-10 flex flex-col h-screen max-w-[1600px] mx-auto p-4 md:p-8 gap-6">
        
        <!-- HEADER -->
        <header class="flex flex-col gap-6 shrink-0">
            <div class="glass rounded-[2rem] p-3 pl-6 flex justify-between items-center shadow-soft">
                <!-- Profile -->
                <div class="flex items-center gap-5">
                    <div class="relative group cursor-pointer" onclick="document.getElementById('avatar-input').click()">
                        <div id="user-avatar" class="w-12 h-12 rounded-2xl overflow-hidden shadow-lg border-2 border-white dark:border-slate-700 transition-transform group-hover:scale-105 group-hover:rotate-3">
                            <!-- Avatar populated by JS -->
                        </div>
                        <input type="file" id="avatar-input" class="hidden" accept="image/*" onchange="handleAvatarUpload(this)">
                        <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white dark:border-slate-800"></div>
                    </div>

                    <div class="flex flex-col">
                        <h1 class="text-xl font-bold tracking-tight text-slate-800 dark:text-white flex items-center gap-2">
                            <span id="greeting-text">Olá</span>
                            <span class="text-[10px] font-bold text-white bg-gradient-to-r from-brand-500 to-purple-500 px-2 py-0.3 rounded-full shadow-lg shadow-brand-500/20">PRO</span>
                        </h1>
                        <p id="date-display" class="text-xs text-slate-500 font-medium capitalize mt-0.5"></p>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="flex items-center gap-2 pr-2">
                    <button onclick="openTrashModal()" class="w-12 h-12 flex items-center justify-center rounded-2xl hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-400 hover:text-rose-500 transition-all btn-hover" title="Lixeira">
                        <i data-lucide="trash" class="w-5 h-5"></i>
                    </button>
                     <button onclick="toggleSettings()" class="w-12 h-12 flex items-center justify-center rounded-2xl hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-400 hover:text-brand-500 transition-all btn-hover" title="Ajustes">
                        <i data-lucide="settings-2" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Stats & Search Bar -->
            <div class="flex flex-col lg:flex-row gap-4">
                <!-- Search -->
                <div class="glass flex-1 rounded-[1.5rem] px-5 py-3 flex items-center gap-4 focus-within:ring-2 ring-brand-500/20 transition-all shadow-sm">
                    <i data-lucide="search" class="w-5 h-5 text-slate-400"></i>
                    <input type="text" id="search-input" onkeyup="renderBoard()" placeholder="Pesquisar tarefas..." class="bg-transparent border-none text-base font-medium text-slate-700 dark:text-white placeholder-slate-400 w-full focus:ring-0 p-0">
                </div>

                <!-- Stats Pills -->
                <div class="flex flex-wrap gap-4 overflow-x-auto pb-1 lg:pb-0">
                    <div class="glass rounded-[1.5rem] px-9 py-2 flex items-center gap-4 min-w-fit shadow-sm" onclick="toggleStats()">
                        <div class="flex gap-1 items-end">
                            <span id="count-todo" class="text-2xl font-bold text-slate-700 dark:text-white">0</span>
                            <span class="text-xs font-semibold text-slate-400 mb-1.5 uppercase">A Fazer</span>
                        </div>
                        <div class="w-px h-8 bg-slate-200 dark:bg-slate-700"></div>
                        <div class="flex gap-1 items-end">
                            <span id="count-doing" class="text-2xl font-bold text-brand-500">0</span>
                            <span class="text-xs font-semibold text-slate-400 mb-1.5 uppercase">Focando</span>
                        </div>
                        <div class="w-px h-8 bg-slate-200 dark:bg-slate-700"></div>
                        <div class="flex gap-1 items-end">
                            <span id="count-done" class="text-2xl font-bold text-emerald-500">0</span>
                            <span class="text-xs font-semibold text-slate-400 mb-1.5 uppercase">Feito</span>
                        </div>
                        
                        <!-- Progress Donut -->
                        <div class="relative w-10 h-10 ml-2">
                            <svg class="w-full h-full -rotate-90" viewBox="0 0 36 36">
                                <path class="text-slate-200 dark:text-slate-700" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" />
                                <path id="progress-bar" class="text-brand-500 transition-all duration-1000 ease-out" stroke-dasharray="100, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" />
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center text-[9px] font-bold text-brand-600 dark:text-brand-400" id="progress-text">0%</div>
                        </div>
                    </div>
                    <button onclick="toggleScratchpad()" class="bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-[1.5rem] px-6 font-bold text-sm shadow-xl hover:shadow-2xl hover:-translate-x-1 transition-all flex items-center gap-2 whitespace-nowrap btn-hover flex-1 py-4">
                        <i data-lucide="notebook-pen" class="w-5 h-5"></i> Anotação rápida
                    </button>

                    <button onclick="openModal()" class="bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-[1.5rem] px-8 font-bold text-sm shadow-xl hover:shadow-2xl hover:-translate-x-1 transition-all flex items-center gap-2 whitespace-nowrap btn-hover flex-1 py-4">
                        <i data-lucide="plus" class="w-5 h-5"></i> Nova Tarefa
                    </button>
                </div>
            </div>
        </header>

        <!-- KANBAN BOARD -->
        <div id="view-kanban" class="flex-1 overflow-x-auto overflow-y-hidden pb-4 -mx-4 px-4 md:mx-0 md:px-0 snap-x-mandatory custom-scrollbar">
            <div class="flex gap-6 h-full w-max md:w-full md:min-w-0">
                
                <!-- Column: To Do -->
                <div class="flex flex-col w-[85vw] md:w-auto md:flex-1 min-w-[320px] bg-white/40 dark:bg-slate-800/40 rounded-[2rem] border border-white/50 dark:border-slate-700/50 backdrop-blur-sm snap-center pb-2">
                    <div class="p-5 flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full bg-slate-400 ring-4 ring-slate-400/20"></div>
                        <h2 class="font-bold text-slate-600 dark:text-slate-300 text-sm uppercase tracking-wide">Para Fazer</h2>
                    </div>
                    <div id="col-todo" class="px-3 flex-1 overflow-y-auto space-y-3 custom-scrollbar" ondrop="drop(event, 'todo')" ondragover="allowDrop(event)"></div>
                </div>

                <!-- Column: Doing -->
                <div class="flex flex-col w-[85vw] md:w-auto md:flex-1 min-w-[320px] bg-white/60 dark:bg-slate-800/60 rounded-[2rem] border border-brand-500/20 dark:border-brand-500/10 backdrop-blur-md snap-center shadow-lg pb-2 relative overflow-hidden">
                    <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-brand-400 to-purple-500"></div>
                    <div class="p-5 flex items-center gap-3">
                        <div class="relative flex h-3 w-3">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-brand-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-3 w-3 bg-brand-500"></span>
                        </div>
                        <h2 class="font-bold text-brand-600 dark:text-brand-400 text-sm uppercase tracking-wide">Em Foco</h2>
                    </div>
                    <div id="col-doing" class="px-3 flex-1 overflow-y-auto space-y-3 custom-scrollbar" ondrop="drop(event, 'doing')" ondragover="allowDrop(event)"></div>
                </div>

                <!-- Column: Done -->
                <div class="flex flex-col w-[85vw] md:w-auto md:flex-1 min-w-[320px] bg-white/40 dark:bg-slate-800/40 rounded-[2rem] border border-white/50 dark:border-slate-700/50 backdrop-blur-sm snap-center pb-2">
                    <div class="p-5 flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full bg-emerald-500 ring-4 ring-emerald-500/20"></div>
                        <h2 class="font-bold text-emerald-600 dark:text-emerald-400 text-sm uppercase tracking-wide flex gap-1 items-end ml-auto lg:ml-0">Concluído</h2>
                    </div>
                    <div id="col-done" class="px-3 flex-1 overflow-y-auto space-y-3 custom-scrollbar" ondrop="drop(event, 'done')" ondragover="allowDrop(event)"></div>
                </div>

            </div>
        </div>
    </div>

    <!-- SIDEBARS -->
    <div id="scratchpad-sidebar" class="fixed top-0 left-0 h-full w-96 glass border-r border-white/20 shadow-2xl z-[80] closed flex flex-col pt-[calc(env(safe-area-inset-top)+20px)] backdrop-blur-2xl">
        <div class="px-8 pb-6 pt-4 flex justify-between items-center">
            <div class="flex items-center gap-3 text-brand-600 dark:text-brand-400">
                <div class="p-2 bg-brand-100 dark:bg-brand-900/30 rounded-xl"><i data-lucide="notebook-pen" class="w-5 h-5"></i></div>
                <span class="font-bold text-lg">Bloco de Notas</span>
            </div>
            <button onclick="toggleScratchpad()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center hover:bg-slate-200 transition-colors"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
        </div>
        <textarea id="scratchpad-area" class="flex-1 w-full bg-transparent px-8 py-4 resize-none text-base text-slate-600 dark:text-slate-300 placeholder-slate-400 outline-none leading-relaxed" placeholder="Digite suas ideias rápidas aqui..."></textarea>
    </div>

    <div id="settings-sidebar" class="fixed top-0 right-0 h-full w-96 glass border-l border-white/20 shadow-2xl z-[80] closed flex flex-col pt-[calc(env(safe-area-inset-top)+20px)] backdrop-blur-2xl">
        <div class="px-8 pb-6 pt-4 flex justify-between items-center">
            <div class="flex items-center gap-3 text-slate-800 dark:text-white">
                <div class="p-2 bg-slate-100 dark:bg-slate-800 rounded-xl"><i data-lucide="sliders-horizontal" class="w-5 h-5"></i></div>
                <span class="font-bold text-lg">Ajustes</span>
            </div>
            <button onclick="toggleSettings()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center hover:bg-slate-200 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        
        <div class="flex-1 overflow-y-auto custom-scrollbar px-8 py-4 space-y-8">
             <section>
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Temas</h3>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button onclick="applyTheme('cyberpunk')" class="p-4 rounded-2xl bg-slate-900 border border-slate-700 text-purple-400 text-xs font-bold hover:scale-105 transition-all shadow-lg">Cyberpunk</button>
                    <button onclick="applyTheme('nature')" class="p-4 rounded-2xl bg-emerald-50 border border-emerald-100 text-emerald-600 text-xs font-bold hover:scale-105 transition-all shadow-lg">Natureza</button>
                    <button onclick="applyTheme('dracula')" class="p-4 rounded-2xl bg-[#282a36] border border-[#44475a] text-[#bd93f9] text-xs font-bold hover:scale-105 transition-all shadow-lg">Dracula</button>
                    <button onclick="applyTheme('minimal')" class="p-4 rounded-2xl bg-white border border-slate-100 text-slate-600 text-xs font-bold hover:scale-105 transition-all shadow-lg">Minimalista</button>
                </div>

                <div class="space-y-4 bg-white/50 dark:bg-slate-800/50 p-4 rounded-2xl">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-3">Cor de Destaque</label>
                        <div class="flex items-center gap-3">
                             <div class="relative w-10 h-10 rounded-full bg-white dark:bg-slate-700 shadow-md flex items-center justify-center overflow-hidden">
                                <input type="color" id="brand-color-picker" oninput="setBrandColor(this.value)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer scale-150">
                                <div id="brand-color-preview" class="w-6 h-6 rounded-full bg-brand-500"></div>
                             </div>
                             <input type="text" id="brand-hex-input" oninput="handleHexInput(this.value, 'brand')" class="flex-1 form-input-modern px-4 text-sm font-medium uppercase" placeholder="#HEX">
                        </div>
                    </div>
                </div>
            </section>

            <section>
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Segurança</h3>
                <div class="flex items-center justify-between p-4 bg-white/50 dark:bg-slate-800/50 rounded-2xl">
                    <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Bloqueio por PIN</span>
                    <button id="btn-set-pin" onclick="setupPin()" class="bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-4 py-2 rounded-xl text-xs font-bold hover:bg-slate-300 transition-colors">Configurar</button>
                </div>
            </section>

            <section>
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Dados</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="exportData()" class="flex flex-col items-center justify-center gap-2 py-4 bg-white/50 dark:bg-slate-800/50 rounded-2xl hover:bg-white transition-colors text-sm font-medium text-slate-600 dark:text-slate-300">
                        <i data-lucide="upload" class="w-5 h-5 text-brand-500"></i> Backup
                    </button>
                    <label class="flex flex-col items-center justify-center gap-2 py-4 bg-white/50 dark:bg-slate-800/50 rounded-2xl hover:bg-white transition-colors text-sm font-medium text-slate-600 dark:text-slate-300 cursor-pointer">
                        <i data-lucide="download" class="w-5 h-5 text-brand-500"></i> Restaurar
                        <input type="file" class="hidden" onchange="importData(this)">
                    </label>
                </div>
            </section>
            
            <section class="pt-2">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Categorias</h3>
                    <button onclick="addCategory()" class="w-6 h-6 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center hover:bg-brand-200 transition-colors"><i data-lucide="plus" class="w-4 h-4"></i></button>
                </div>
                <div id="categories-list" class="space-y-3"></div>
            </section>
        </div>
        <div class="p-6 text-center">
            <p class="text-[10px] text-slate-400 font-medium">FLOWTASK v2.5</p>
        </div>
    </div>
    <div id="settings-overlay" onclick="toggleSettings()" class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-[75] hidden transition-opacity"></div>
    <div id="scratchpad-overlay" onclick="toggleScratchpad()" class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-[75] hidden transition-opacity"></div>

    <!-- STATS MODAL -->
    <div id="stats-modal" class="fixed inset-0 z-[65] hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-md transition-opacity" onclick="toggleStats()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-slate-900 w-full max-w-2xl rounded-[2.5rem] shadow-2xl p-8 transform transition-all animate-scale-in max-h-[90vh] overflow-y-auto custom-scrollbar relative">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold flex items-center gap-3">
                        <div class="p-2 bg-brand-100 rounded-xl text-brand-600"><i data-lucide="activity" class="w-6 h-6"></i></div>
                        Relatório de Foco
                    </h2>
                    <button onclick="toggleStats()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center hover:bg-slate-200 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                
                <div id="stats-content" class="grid md:grid-cols-2 gap-8">
                    <!-- Key Metrics -->
                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-50 dark:bg-slate-800 p-6 rounded-[1.5rem] text-center">
                                 <span class="block text-4xl font-extrabold text-slate-800 dark:text-white mb-1" id="stat-completion-rate">0%</span>
                                 <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Eficiência</span>
                            </div>
                            <div class="bg-brand-50 dark:bg-brand-900/20 p-6 rounded-[1.5rem] text-center border border-brand-100 dark:border-brand-500/20">
                                 <span class="block text-4xl font-extrabold text-brand-600 dark:text-brand-400 mb-1" id="stat-pomodoros">0</span>
                                 <span class="text-xs font-bold text-brand-400/80 uppercase tracking-wider">Ciclos Foco</span>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 p-6 rounded-[1.5rem] shadow-sm">
                             <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Progresso Semanal</h4>
                             <div class="h-32 w-full"><canvas id="historyChart"></canvas></div>
                        </div>
                    </div>

                    <!-- Category Breakdown -->
                    <div class="space-y-6">
                        <div class="bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 p-6 rounded-[1.5rem] shadow-sm h-full flex flex-col">
                            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Distribuição</h4>
                            <div class="h-48 flex justify-center mb-6"><canvas id="categoryChart"></canvas></div>
                            <div id="stats-categories-list" class="space-y-2 flex-1"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TRASH MODAL -->
    <div id="trash-modal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-md transition-opacity" onclick="closeTrashModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-[2rem] shadow-2xl p-6 animate-scale-in h-[500px] flex flex-col relative overflow-hidden">
                <div class="flex justify-between items-center mb-6 shrink-0">
                    <h2 class="text-xl font-bold text-rose-500 flex items-center gap-2"><i data-lucide="trash-2"></i> Lixeira</h2>
                    <button onclick="closeTrashModal()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center hover:bg-slate-200 transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                <div class="bg-rose-50 dark:bg-rose-900/20 text-rose-600 dark:text-rose-300 text-xs font-medium px-4 py-3 rounded-xl mb-4 shrink-0 flex items-center gap-2">
                    <i data-lucide="info" class="w-4 h-4"></i> Itens excluídos por mais de 24h somem.
                </div>
                <div id="trash-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-3 p-1"></div>
            </div>
        </div>
    </div>

    <!-- TASK MODAL -->
    <div id="task-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-[2.5rem] shadow-2xl p-8 transform transition-all animate-scale-in max-h-[90vh] overflow-y-auto custom-scrollbar">
                <div class="flex justify-between items-center mb-8">
                    <h2 id="modal-title" class="text-2xl font-bold text-slate-800 dark:text-white">Nova Tarefa</h2>
                    <button onclick="closeModal()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center hover:bg-slate-200 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                
                <form id="task-form" onsubmit="saveTask(event)" class="space-y-6">
                    <div>
                        <div class="flex justify-between items-end mb-2">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider pl-1">O que precisa ser feito?</label>
                            <button type="button" onclick="startDictation('task-title')" class="text-brand-500 hover:bg-brand-50 rounded-full p-1 transition-colors"><i data-lucide="mic" class="w-4 h-4"></i></button>
                        </div>
                        <input type="text" id="task-title" required class="w-full form-input-modern px-5 text-lg font-medium outline-none text-slate-800 dark:text-white transition-all placeholder:text-slate-400" placeholder="Ex: Terminar projeto..." onblur="attemptNLP(this.value)">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-5">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider pl-1">Prazo</label>
                            <div class="relative">
                                <i data-lucide="calendar" class="absolute left-4 top-3.5 w-5 h-5 text-slate-400"></i>
                                <input type="date" id="task-due-date" class="w-full form-input-modern pl-12 pr-4 outline-none text-slate-700 dark:text-white font-medium cursor-pointer">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider pl-1">Categoria</label>
                            <div class="relative">
                                <i data-lucide="tag" class="absolute left-4 top-3.5 w-5 h-5 text-slate-400"></i>
                                <select id="task-category" class="w-full form-input-modern pl-12 pr-4 outline-none text-slate-700 dark:text-white cursor-pointer font-medium appearance-none bg-transparent"></select>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-end mb-2">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider pl-1">Tags & Metadata</label>
                            <button type="button" onclick="generateTags()" id="btn-magic-tags" class="text-xs bg-gradient-to-r from-purple-500 to-brand-500 text-white px-3 py-1 rounded-full flex items-center gap-1 shadow-lg hover:shadow-xl hover:scale-105 transition-all"><i data-lucide="sparkles" class="w-3 h-3"></i> IA Sugerir</button>
                        </div>
                        <input type="text" id="task-tags" class="w-full form-input-modern px-5 text-sm font-medium outline-none text-slate-700 dark:text-white placeholder:text-slate-400" placeholder="trabalho, urgente...">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-5">
                         <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider pl-1">Recorrência</label>
                            <div class="relative">
                                <i data-lucide="repeat" class="absolute left-4 top-3.5 w-5 h-5 text-slate-400"></i>
                                <select id="task-repeat" class="w-full form-input-modern pl-12 pr-4 outline-none text-slate-700 dark:text-white cursor-pointer font-medium appearance-none bg-transparent">
                                    <option value="none">Não repetir</option>
                                    <option value="daily">Diariamente</option>
                                    <option value="weekly">Semanalmente</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider pl-1">Prioridade</label>
                            <div class="flex gap-2">
                                <label class="cursor-pointer flex-1 group"><input type="radio" name="priority" value="low" class="peer sr-only"><div class="h-[48px] rounded-2xl border-2 border-transparent bg-slate-100 dark:bg-slate-800 peer-checked:bg-emerald-100 peer-checked:border-emerald-500 peer-checked:text-emerald-700 flex items-center justify-center font-bold text-sm text-slate-500 transition-all hover:scale-105">Baixa</div></label>
                                <label class="cursor-pointer flex-1 group"><input type="radio" name="priority" value="medium" class="peer sr-only" checked><div class="h-[48px] rounded-2xl border-2 border-transparent bg-slate-100 dark:bg-slate-800 peer-checked:bg-amber-100 peer-checked:border-amber-500 peer-checked:text-amber-700 flex items-center justify-center font-bold text-sm text-slate-500 transition-all hover:scale-105">Média</div></label>
                                <label class="cursor-pointer flex-1 group"><input type="radio" name="priority" value="high" class="peer sr-only"><div class="h-[48px] rounded-2xl border-2 border-transparent bg-slate-100 dark:bg-slate-800 peer-checked:bg-rose-100 peer-checked:border-rose-500 peer-checked:text-rose-700 flex items-center justify-center font-bold text-sm text-slate-500 transition-all hover:scale-105">Alta</div></label>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-end mb-2"><label class="text-xs font-bold text-slate-500 uppercase tracking-wider pl-1">Checklist</label><button type="button" onclick="generateSubtasks()" id="btn-magic-subtasks" class="text-xs bg-gradient-to-r from-purple-500 to-brand-500 text-white px-3 py-1 rounded-full flex items-center gap-1 shadow-lg hover:shadow-xl hover:scale-105 transition-all"><i data-lucide="sparkles" class="w-3 h-3"></i> IA Gerar</button></div>
                        <div class="flex gap-3 mb-3">
                            <div class="relative flex-1">
                                <input type="text" id="new-subtask-input" class="w-full form-input-modern px-5 pr-10 text-sm font-medium outline-none text-slate-700 dark:text-white transition-all" placeholder="Adicionar etapa..." onkeypress="if(event.key === 'Enter'){event.preventDefault(); addSubtaskToForm();}">
                            </div>
                            <button type="button" onclick="addSubtaskToForm()" class="w-[48px] h-[48px] flex items-center justify-center bg-slate-100 dark:bg-slate-800 rounded-2xl hover:bg-brand-500 hover:text-white transition-colors"><i data-lucide="plus" class="w-5 h-5"></i></button>
                        </div>
                        <ul id="subtask-list-form" class="space-y-2 max-h-32 overflow-y-auto custom-scrollbar"></ul>
                    </div>

                    <div class="flex justify-end gap-4 pt-6 mt-4">
                        <button type="button" class="px-6 py-3 rounded-2xl text-sm font-bold text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="px-8 py-3 bg-slate-900 dark:bg-white hover:bg-brand-600 dark:hover:bg-brand-200 text-white dark:text-slate-900 rounded-2xl font-bold text-sm shadow-xl hover:shadow-2xl hover:translate-y-1 transition-all">Salvar Tarefa</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- POMODORO MODAL -->
    <div id="pomodoro-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-slate-900/90 backdrop-blur-xl flex flex-col items-center justify-center text-white p-4">
            
            <button onclick="closePomodoro()" class="absolute top-8 right-8 p-4 bg-white/10 hover:bg-white/20 rounded-full transition-colors z-20"><i data-lucide="x" class="w-6 h-6"></i></button>
            
            <div class="mb-10 text-center animate-scale-in w-full max-w-lg flex flex-col items-center relative z-10">
                <span class="text-brand-300 font-bold tracking-widest uppercase text-xs bg-white/10 px-4 py-1.5 rounded-full mb-6">Modo Foco</span>
                <h2 id="pomo-task-title" class="text-2xl md:text-4xl font-bold mx-auto truncate px-4 w-full"></h2>
                
                <div class="w-full px-6 mt-8 min-h-[4rem] flex items-center justify-center gap-2">
                    <button id="btn-motivate" onclick="generateMotivation()" class="text-sm font-medium text-white/80 hover:text-white flex items-center gap-2 bg-gradient-to-r from-brand-500 to-purple-600 px-6 py-3 rounded-full shadow-lg hover:shadow-glow hover:translate-y-1 transition-all"><i data-lucide="zap" class="w-4 h-4 text-yellow-300"></i> Motivação IA</button>
                    <div id="motivation-text" class="hidden text-lg text-white font-medium italic animate-slide-up w-full text-center relative"><span class="text-4xl opacity-30 absolute -top-4 left-0">"</span><span id="motivation-content"></span><span class="text-4xl opacity-30 absolute -bottom-6 right-0">"</span></div>
                </div>
            </div>
            
            <div class="flex gap-3 mb-12 bg-white/10 p-2 rounded-2xl overflow-x-auto max-w-full shrink-0 z-10">
                <button onclick="setTimerDuration(5)" class="timer-btn px-5 py-2.5 rounded-xl text-sm font-bold text-white/60 hover:bg-white/10 hover:text-white transition-all" data-time="05">05</button>
                <button onclick="setTimerDuration(15)" class="timer-btn px-5 py-2.5 rounded-xl text-sm font-bold text-white/60 hover:bg-white/10 hover:text-white transition-all" data-time="15">15</button>
                <button onclick="setTimerDuration(25)" class="timer-btn px-5 py-2.5 rounded-xl bg-white text-brand-600 font-bold shadow-lg" data-time="25">25</button>
                <button onclick="setTimerDuration(45)" class="timer-btn px-5 py-2.5 rounded-xl text-sm font-bold text-white/60 hover:bg-white/10 hover:text-white transition-all" data-time="45">45</button>
                <button onclick="setTimerDuration(60)" class="timer-btn px-5 py-2.5 rounded-xl text-sm font-bold text-white/60 hover:bg-white/10 hover:text-white transition-all" data-time="60">60</button>
            </div>

            <div class="relative w-80 h-80 shrink-0 flex items-center justify-center group/timer z-10">
                <svg class="w-full h-full transform drop-shadow-2xl" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="4" stroke-linecap="round" />
                    <circle id="timer-circle" class="progress-ring__circle" cx="50" cy="50" r="45" fill="none" stroke="#fff" stroke-width="4" stroke-linecap="round" stroke-dasharray="283" stroke-dashoffset="0" />
                </svg>
                
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <input type="tel" id="hidden-timer-input" class="absolute inset-0 w-full h-full opacity-0 z-20 cursor-pointer" inputmode="numeric" maxlength="4" autocomplete="off">
                    <div id="timer-display" class="text-7xl font-bold tracking-tighter flex items-center justify-center text-white select-none">25:00</div>
                    <span id="timer-status" class="text-white/50 mt-2 text-sm uppercase tracking-widest font-bold">Toque para iniciar</span>
                </div>
            </div>
            
            <div class="mt-12 flex items-center gap-8 z-10">
                <button id="btn-toggle-timer" onclick="toggleTimer()" class="w-24 h-24 rounded-full bg-white text-brand-600 hover:scale-110 flex items-center justify-center shadow-2xl transition-all active:scale-95 group">
                    <i data-lucide="play" class="w-10 h-10 fill-current ml-1"></i>
                </button>
                <button onclick="resetTimer()" class="w-16 h-16 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-all text-white hover:rotate-180 duration-500"><i data-lucide="rotate-ccw" class="w-6 h-6"></i></button>
            </div>
        </div>
    </div>

    <canvas id="confetti" class="fixed inset-0 pointer-events-none z-[70]"></canvas>

    <!-- LOGIC -->
    <script>
        let tasks = [], tempSubtasks = [], currentEditingId = null, timerInterval = null, initialTime = 25*60, timeLeft = 25*60, isTimerRunning = false, isEditingTimer = false, timerDigits = [], expandedTasks = new Set(), soundEnabled = true, pomoCount = 0;
        let completionLog = []; 
        let audioContext = null, noiseNode = null;
        let pinInputBuffer = "";
        let historyChartInstance = null;
        let pieChartInstance = null;
        let lastDeletedTask = null;

        let categories = [
            { id: 'cat_1', name: 'Trabalho', color: '#4f46e5' },
            { id: 'cat_2', name: 'Pessoal', color: '#ec4899' },
            { id: 'cat_3', name: 'Estudo', color: '#f59e0b' },
            { id: 'cat_4', name: 'Saúde', color: '#10b981' }
        ];

        // Temas Modernos e Limpos
        const themes = {
            cyberpunk: { bg: '#0f172a', brand: '#8b5cf6', mode: 'dark' }, 
            nature: { bg: '#f0fdfa', brand: '#0d9488', mode: 'light' },
            dracula: { bg: '#282a36', brand: '#bd93f9', mode: 'dark' },
            minimal: { bg: '#ffffff', brand: '#171717', mode: 'light' }
        };
        
        function getLocalDate() {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function applyTheme(name) {
            const t = themes[name];
            if(t) {
                setBackgroundColor(t.bg);
                setBrandColor(t.brand);
                if (t.mode === 'dark') {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            }
        }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep() {
            if(!soundEnabled) return;
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination); o.type = 'sine'; o.frequency.value = 880;
            g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5);
            o.start(); o.stop(audioCtx.currentTime + 0.5);
        }

        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); });
        if ('Notification' in window) Notification.requestPermission();
        window.addEventListener('offline', () => document.getElementById('offline-indicator').classList.remove('hidden'));
        window.addEventListener('online', () => document.getElementById('offline-indicator').classList.add('hidden'));
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            if (e.key === 'n' || e.key === 'N') openModal();
            if (e.key === 'Escape') {toggleSettings();}
            if (e.key === 'Shift') {toggleScratchpad();}
            if (e.key === 's') {toggleStats();}
            if (e.key === 'choose') {closeModal();}
            if (e.key === 'choose') {closeTrashModal();}
            if (e.key === '/') { e.preventDefault(); document.getElementById('search-input').focus(); }
        });

        document.addEventListener('DOMContentLoaded', () => {
            checkPin();
            loadSettings(); 
            loadTasks(); loadCategories(); loadAvatar(); updateGreeting(); cleanupTrash();
            loadScratchpad(); 
            const pc = localStorage.getItem('pomo_count'); if(pc) { pomoCount = parseInt(pc); }
            try {
                const cl = localStorage.getItem('flowtask_log'); if(cl) { completionLog = JSON.parse(cl); }
            } catch(e) { console.error("Erro log", e); }
            lucide.createIcons();
            const h = document.getElementById('hidden-timer-input'); 
            h.addEventListener('input', handleTimerInput); 
            h.addEventListener('blur', finishTimerEdit);
            h.addEventListener('focus', startTimerEdit);
        });
        
        function loadSettings() {
            if(localStorage.getItem('theme') === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            const savedBg = localStorage.getItem('flowtask_bg_color');
            if(savedBg) {
                document.documentElement.style.setProperty('--bg-solid', savedBg);
                const p = document.getElementById('brand-color-picker'); if(p) p.value = savedBg;
            }
            const savedBrand = localStorage.getItem('flowtask_brand_color');
            if(savedBrand) setBrandColor(savedBrand, false);
        }

        function toggleScratchpad() {
            document.getElementById('scratchpad-sidebar').classList.toggle('closed');
            document.getElementById('scratchpad-overlay').classList.toggle('hidden');
        }
        function loadScratchpad() {
            const content = localStorage.getItem('flowtask_scratchpad') || '';
            const area = document.getElementById('scratchpad-area');
            area.value = content;
            area.addEventListener('input', (e) => localStorage.setItem('flowtask_scratchpad', e.target.value));
        }

        function attemptNLP(text) {
            const titleInput = document.getElementById('task-title');
            const dateInput = document.getElementById('task-due-date');
            
            const lower = text.toLowerCase();
            const today = new Date();
            let targetDate = null;

            if (lower.includes('hoje')) {
                targetDate = today;
                titleInput.value = text.replace(/hoje/gi, '').trim();
            } else if (lower.includes('amanhã') || lower.includes('amanha')) {
                targetDate = new Date(today);
                targetDate.setDate(today.getDate() + 1);
                titleInput.value = text.replace(/amanhã|amanha/gi, '').trim();
            } 

            if (targetDate) {
                dateInput.value = targetDate.toISOString().split('T')[0];
            }
        }

        async function generateTags() {
            const t = document.getElementById('task-title').value;
            if(!t) { alert("Digite um título primeiro"); return; }
            const btn = document.getElementById('btn-magic-tags');
            const originalText = btn.innerHTML;
            btn.innerHTML = '...'; btn.disabled = true;
            
            const prompt = `Gere 3 tags curtas (uma palavra cada) separadas por vírgula para a tarefa: "${t}". Em minúsculas. Ex: trabalho, urgente`;
            const result = await callGemini(prompt);
            
            if(result) {
                const tags = result.replace(/\./g, '').split(',').map(s => s.trim()).join(', ');
                document.getElementById('task-tags').value = tags;
            }
            btn.innerHTML = originalText; btn.disabled = false;
        }

        let undoTimeout;
        function showUndoToast(actionType, task) {
            const toast = document.getElementById('undo-toast');
            lastDeletedTask = task; 
            
            toast.querySelector('span').innerText = actionType === 'delete' ? 'Tarefa removida' : 'Tarefa concluída';
            toast.classList.remove('hidden');
            // Animação de entrada
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            });

            clearTimeout(undoTimeout);
            undoTimeout = setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 500);
                lastDeletedTask = null; 
            }, 3000); 
        }

        function performUndo() {
            if (lastDeletedTask) {
                const t = lastDeletedTask;
                if(t.status === 'trash') {
                    t.status = 'todo'; 
                    delete t.deletedAt;
                } else if(t.status === 'done') {
                    t.status = 'todo'; 
                    completionLog.pop(); 
                    localStorage.setItem('flowtask_log', JSON.stringify(completionLog));
                }
                
                if(!tasks.find(x => x.id === t.id)) {
                    tasks.push(t);
                }

                saveTasks();
                
                const toast = document.getElementById('undo-toast');
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 500);
                clearTimeout(undoTimeout);
                lastDeletedTask = null;
            }
        }
        
        function completeTask(e, id) { 
            if(e) e.stopPropagation(); 
            const t = tasks.find(t => t.id === id); 
            if(t) { 
                completionLog.push({ date: getLocalDate(), taskId: t.id });
                localStorage.setItem('flowtask_log', JSON.stringify(completionLog));

                if (t.repeat && t.repeat !== 'none') {
                    if(t.subtasks) t.subtasks.forEach(s => s.completed = false);
                    const nextDate = new Date();
                    if (t.repeat === 'daily') nextDate.setDate(nextDate.getDate() + 1);
                    if (t.repeat === 'weekly') nextDate.setDate(nextDate.getDate() + 7);
                    t.dueDate = nextDate.toISOString().split('T')[0];
                    t.status = 'todo'; 
                } else {
                    t.status = 'done'; 
                    if(t.subtasks) t.subtasks.forEach(s => s.completed = true); 
                    
                    setTimeout(() => {
                        showUndoToast('complete', t);
                        saveTasks();
                        requestAnimationFrame(() => {
                            fireConfetti();
                        });
                    }, 50); 
                    return; 
                }
                saveTasks(); 
                fireConfetti(); 
            } 
        }

        function startDictation(targetId) {
            if ('webkitSpeechRecognition' in window) {
                const recognition = new webkitSpeechRecognition();
                recognition.lang = 'pt-BR';
                recognition.start();
                recognition.onresult = function(event) {
                    document.getElementById(targetId).value = event.results[0][0].transcript;
                    if(targetId === 'task-title') attemptNLP(event.results[0][0].transcript);
                };
            } else { alert("Reconhecimento de voz não suportado."); }
        }

        function generateId() { return Math.random().toString(36).substr(2, 9); }
        function loadTasks() { 
            try {
                const t = localStorage.getItem('flowtask_tasks'); 
                if(t) { 
                    tasks = JSON.parse(t); 
                    tasks.forEach(task => { 
                        if(!task.subtasks) task.subtasks = []; 
                        if(!task.repeat) task.repeat = 'none'; 
                        if(!task.tags) task.tags = [];
                    }); 
                } 
            } catch(e) { console.error(e); tasks = []; }
            renderBoard(); 
        }
        function saveTasks() { localStorage.setItem('flowtask_tasks', JSON.stringify(tasks)); renderBoard(); }
        
        function updateGreeting() {
            const h = new Date().getHours();
            let g = 'Bom dia'; if (h >= 12 && h < 18) g = 'Boa tarde'; else if (h >= 18) g = 'Boa noite';
            document.getElementById('greeting-text').innerText = g;
            document.getElementById('date-display').innerText = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' });
        }
        
        function loadCategories() { 
            try { const saved = localStorage.getItem('flowtask_categories'); if(saved) categories = JSON.parse(saved); } catch(e) {}
            renderCategoriesSettings(); 
        }
        function saveCategories() { localStorage.setItem('flowtask_categories', JSON.stringify(categories)); renderCategoriesSettings(); renderBoard(); }
        
        function renderCategoriesSettings() {
            const list = document.getElementById('categories-list');
            list.innerHTML = categories.map(cat => `
                <div class="flex items-center gap-3 group p-3 bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 transition-transform hover:scale-105">
                    <div id="cat-color-box-${cat.id}" class="relative w-8 h-8 shrink-0 rounded-full overflow-hidden cursor-pointer shadow-md" style="background-color: ${cat.color}">
                        <input type="color" value="${cat.color}" onchange="updateCategory('${cat.id}', 'color', this.value)" class="absolute inset-0 opacity-0 cursor-pointer">
                    </div>
                    <input type="text" value="${cat.name}" onchange="updateCategory('${cat.id}', 'name', this.value)" class="flex-1 bg-transparent text-sm font-bold text-slate-700 dark:text-slate-200 outline-none" placeholder="Nome">
                    <button onclick="deleteCategory('${cat.id}')" class="text-slate-400 hover:text-rose-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function addCategory() { const colors = ['#4f46e5', '#ec4899', '#10b981', '#f59e0b', '#3b82f6']; categories.push({ id: generateId(), name: 'Nova Categoria', color: colors[Math.floor(Math.random() * colors.length)] }); saveCategories(); }
        function updateCategory(id, field, value) { const cat = categories.find(c => c.id === id); if(cat) { if(field === 'name') { const old = cat.name; cat.name = value; tasks.forEach(t => { if(t.category === old) t.category = value; }); saveTasks(); saveCategories(); } else if (field === 'color') { cat[field] = value; document.getElementById(`cat-color-box-${id}`).style.backgroundColor = value; } } }
        function deleteCategory(id) { if(categories.length <= 1) return; if(confirm("Excluir categoria?")) { categories = categories.filter(c => c.id !== id); saveCategories(); } }
        function renderTaskModalCategories() { const s = document.getElementById('task-category'); if(!s) return; s.innerHTML = categories.map(c => `<option value="${c.name}">${c.name}</option>`).join(''); }

        function exportData() { 
            const data = { tasks, categories, completionLog, pomoCount, preferences: { brandColor: localStorage.getItem('flowtask_brand_color'), bgColor: localStorage.getItem('flowtask_bg_color'), theme: localStorage.getItem('theme') } };
            const d = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data)); 
            const a = document.createElement('a'); a.setAttribute("href", d); a.setAttribute("download", "flowtask_data.json"); document.body.appendChild(a); a.click(); a.remove(); 
        }

        function importData(input) { 
            const f = input.files[0]; if (!f) return; 
            const r = new FileReader(); 
            r.onload = (e) => { 
                try { 
                    const d = JSON.parse(e.target.result); 
                    if(d.tasks) { tasks = d.tasks; saveTasks(); } 
                    if(d.categories) { categories = d.categories; saveCategories(); } 
                    if(d.completionLog) { completionLog = d.completionLog; localStorage.setItem('flowtask_log', JSON.stringify(completionLog)); } 
                    if(d.pomoCount) { localStorage.setItem('pomo_count', d.pomoCount); }
                    if(d.preferences) {
                        if(d.preferences.brandColor) localStorage.setItem('flowtask_brand_color', d.preferences.brandColor);
                        if(d.preferences.bgColor) localStorage.setItem('flowtask_bg_color', d.preferences.bgColor);
                        if(d.preferences.theme) localStorage.setItem('theme', d.preferences.theme);
                    }
                    location.reload(); 
                } catch (err) { alert("Arquivo corrompido."); } 
            }; 
            r.readAsText(f); 
        }

        function toggleSettings() { document.getElementById('settings-sidebar').classList.toggle('closed'); document.getElementById('settings-overlay').classList.toggle('hidden'); }
        function hexToRgb(hex) { const r = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return r ? `${parseInt(r[1], 16)} ${parseInt(r[2], 16)} ${parseInt(r[3], 16)}` : null; }
        
        function setBrandColor(hex, save = true) { 
            if(!hex.startsWith('#')) hex = '#'+hex; 
            const el1 = document.getElementById('brand-color-picker'); if(el1) el1.value = hex; 
            const el2 = document.getElementById('brand-hex-input'); if(el2) el2.value = hex; 
            const el3 = document.getElementById('brand-color-preview'); if(el3) el3.style.backgroundColor = hex;
            
            if(!/^#([0-9A-F]{3}){1,2}$/i.test(hex)) return; 
            const rgb = hexToRgb(hex); 
            if(rgb) { 
                document.documentElement.style.setProperty('--color-brand-500', rgb); 
                document.documentElement.style.setProperty('--color-brand-600', rgb); 
                const tc = document.getElementById('timer-circle'); if(tc) tc.style.stroke = `rgb(${rgb})`; 
                if(save) localStorage.setItem('flowtask_brand_color', hex);
            } 
        }

        function setBackgroundColor(hex) { 
            document.documentElement.style.setProperty('--bg-solid', hex); 
            localStorage.setItem('flowtask_bg_color', hex); 
        }
        
        function handleHexInput(val, type) { if(!val.startsWith('#')) val = '#' + val; if(val.length === 7) { if(type === 'brand') setBrandColor(val); } }

        async function callGemini(p) { let k = localStorage.getItem('gemini_api_key'); if (!k) { k = prompt("API Key Gemini necessária:"); if (k) localStorage.setItem('gemini_api_key', k); else return null; } try { const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${k}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: p }] }] }) }); if (!r.ok) throw new Error('API Error'); const d = await r.json(); return d.candidates?.[0]?.content?.parts?.[0]?.text; } catch (e) { console.error(e); alert("Falha na conexão IA."); return null; } }
        async function generateSubtasks() { const t = document.getElementById('task-title').value; if(!t) return; const b = document.getElementById('btn-magic-subtasks'); const old = b.innerHTML; b.innerHTML = `Gerando...`; b.disabled = true; lucide.createIcons(); const r = await callGemini(`Lista de 3-5 sub-tarefas curtas para: "${t}". Texto puro.`); if(r) { r.split('\n').filter(l => l.trim().length > 0).forEach(l => { const cl = l.replace(/^[\*\-\d\.]+\s*/, '').trim(); if(cl) { tempSubtasks.push({title: cl, completed: false}); } }); renderSubtasks(); } b.disabled = false; b.innerHTML = old; lucide.createIcons(); }
        async function generateMotivation() { const t = document.getElementById('pomo-task-title').innerText; const b = document.getElementById('btn-motivate'); const txt = document.getElementById('motivation-text'); const c = document.getElementById('motivation-content'); b.classList.add('hidden'); txt.classList.remove('hidden'); c.innerText = "Pensando..."; const p = `Frase motivacional curta (max 15 palavras) para: "${t}". Sem formatação.`; const r = await callGemini(p); if(r) c.innerText = r.replace(/\*\*/g, '').trim(); else c.innerText = "Mantenha o foco. Você consegue."; }

        function handleAvatarUpload(input) { const f = input.files[0]; if(f) { const r = new FileReader(); r.onload = (e) => { localStorage.setItem('user_avatar', e.target.result); loadAvatar(); }; r.readAsDataURL(f); } }
        function loadAvatar() { 
            const av = localStorage.getItem('user_avatar'); 
            const el = document.getElementById('user-avatar'); 
            if(av) { 
                el.innerHTML = `<img src="${av}" class="w-full h-full object-cover">`; 
            } else { 
                el.innerHTML = `<div class="w-full h-full bg-gradient-to-br from-brand-500 to-purple-600 flex items-center justify-center text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>`; 
            } 
        }

        function checkPin() { const pin = localStorage.getItem('flowtask_pin'); if(pin) { document.getElementById('pin-screen').classList.remove('hidden'); pinInputBuffer = ""; updatePinDots(); } updatePinButton(); }
        function pinPress(num) { if(pinInputBuffer.length < 4) { pinInputBuffer += num; updatePinDots(); if(pinInputBuffer.length === 4) { setTimeout(verifyPin, 200); } } }
        function pinDelete() { if(pinInputBuffer.length > 0) { pinInputBuffer = pinInputBuffer.slice(0, -1); updatePinDots(); } }
        function updatePinDots() { for(let i=0; i<4; i++) { const dot = document.getElementById(`dot-${i}`); if(i < pinInputBuffer.length) dot.classList.add('filled'); else dot.classList.remove('filled'); } }
        function verifyPin() { const correct = localStorage.getItem('flowtask_pin'); if(pinInputBuffer === correct) { document.getElementById('pin-screen').classList.add('hidden'); pinInputBuffer = ""; } else { document.getElementById('pin-dots').classList.add('animate-shake'); setTimeout(() => { document.getElementById('pin-dots').classList.remove('animate-shake'); pinInputBuffer = ""; updatePinDots(); }, 500); } }
        function setupPin() { const current = localStorage.getItem('flowtask_pin'); if(current) { if(confirm("Desativar PIN?")) { localStorage.removeItem('flowtask_pin'); updatePinButton(); } } else { const newPin = prompt("Defina um PIN de 4 números:"); if(newPin && newPin.length === 4 && !isNaN(newPin)) { localStorage.setItem('flowtask_pin', newPin); updatePinButton(); } } }
        function updatePinButton() { const btn = document.getElementById('btn-set-pin'); btn.innerText = localStorage.getItem('flowtask_pin') ? 'Remover' : 'Configurar'; }

        function toggleStats() { 
            const m = document.getElementById('stats-modal'); 
            if(m.classList.contains('hidden')) { m.classList.remove('hidden'); renderStats(); } else { m.classList.add('hidden'); } 
        }
        function renderStats() {
            const total = tasks.filter(t => t.status !== 'trash').length;
            const done = tasks.filter(t => t.status === 'done').length;
            const rate = total ? Math.round((done/total)*100) : 0;
            document.getElementById('stat-completion-rate').innerText = `${rate}%`;
            document.getElementById('stat-pomodoros').innerText = pomoCount;

            const byCat = {}; categories.forEach(c => byCat[c.name] = 0);
            tasks.filter(t => t.status !== 'trash').forEach(t => { if(byCat[t.category] !== undefined) byCat[t.category]++; });
            
            document.getElementById('stats-categories-list').innerHTML = `<div class="space-y-3">${Object.entries(byCat).map(([name, count]) => { const cat = categories.find(c => c.name === name); const w = total ? (count/total)*100 : 0; return `<div class="flex items-center gap-3"><span class="w-20 truncate text-slate-500 dark:text-slate-400 font-bold text-xs">${name}</span><div class="flex-1 h-3 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden"><div class="h-full rounded-full transition-all duration-1000" style="width: ${w}%; background-color: ${cat.color}"></div></div><span class="w-8 text-right text-slate-600 font-bold text-xs">${count}</span></div>`; }).join('')}</div>`;

            const ctxHistory = document.getElementById('historyChart').getContext('2d');
            if(historyChartInstance) historyChartInstance.destroy();
            const labelsH = []; const dataH = [];
            for(let i=6; i>=0; i--) { const d = new Date(); d.setDate(d.getDate() - i); labelsH.push(d.toLocaleDateString('pt-BR', {weekday: 'short'})); dataH.push(completionLog.filter(l => l.date === d.toISOString().split('T')[0]).length); }
            historyChartInstance = new Chart(ctxHistory, { type: 'bar', data: { labels: labelsH, datasets: [{ label: 'Feito', data: dataH, backgroundColor: '#6366f1', borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { display: false }, ticks: { display: false } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } } });

            const ctxPie = document.getElementById('categoryChart').getContext('2d');
            if(pieChartInstance) pieChartInstance.destroy();
            pieChartInstance = new Chart(ctxPie, { type: 'doughnut', data: { labels: Object.keys(byCat), datasets: [{ data: Object.values(byCat), backgroundColor: categories.map(c => c.color), borderWidth: 0, borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '75%' } });
        }

        function cleanupTrash() { const now = Date.now(); const oneDay = 24 * 60 * 60 * 1000; const initialLen = tasks.length; tasks = tasks.filter(t => { if(t.status === 'trash' && t.deletedAt) { return (now - t.deletedAt) < oneDay; } return true; }); if(tasks.length !== initialLen) saveTasks(); }
        function requestDelete(e, id) { 
            if(e) e.stopPropagation(); 
            const t = tasks.find(x => x.id === id);
            if(t) {
                t.status = 'trash'; t.deletedAt = Date.now();
                saveTasks();
                setTimeout(() => { renderBoard(); showUndoToast('delete', t); }, 0);
            }
        }
        function restoreTask(id) { const t = tasks.find(x => x.id === id); if(t) { t.status = 'todo'; delete t.deletedAt; saveTasks(); openTrashModal(); } }
        function deletePermanently(id) { tasks = tasks.filter(t => t.id !== id); saveTasks(); openTrashModal(); }
        function openTrashModal() { document.getElementById('trash-modal').classList.remove('hidden'); const trashList = document.getElementById('trash-list'); const deleted = tasks.filter(t => t.status === 'trash'); if(deleted.length === 0) { trashList.innerHTML = '<div class="text-center text-slate-400 font-bold py-10 text-sm">Lixeira Vazia</div>'; } else { trashList.innerHTML = deleted.map(t => `<div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl"><span class="text-sm font-bold text-slate-600 dark:text-slate-300 truncate flex-1 pr-2">${t.title}</span><div class="flex gap-2"><button onclick="restoreTask('${t.id}')" class="text-emerald-500 hover:bg-emerald-100 p-2 rounded-xl transition-colors"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button><button onclick="deletePermanently('${t.id}')" class="text-rose-500 hover:bg-rose-100 p-2 rounded-xl transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button></div></div>`).join(''); lucide.createIcons(); } }
        function closeTrashModal() { document.getElementById('trash-modal').classList.add('hidden'); }

        function renderBoard() {
            const filter = document.getElementById('search-input').value.toLowerCase();
            const cols = { todo: document.getElementById('col-todo'), doing: document.getElementById('col-doing'), done: document.getElementById('col-done') };
            Object.values(cols).forEach(c => c.innerHTML = '');
            
            const activeTasks = tasks.filter(t => t.status !== 'trash');
            const sorted = [...activeTasks].filter(t => {
                const titleMatch = t.title.toLowerCase().includes(filter);
                const tagMatch = t.tags && t.tags.some(tag => tag.toLowerCase().includes(filter));
                return titleMatch || tagMatch;
            }).sort((a, b) => (a.priority === 'high' ? -1 : 1));
            
            let counts = { todo: 0, doing: 0, done: 0 };
            const today = new Date().toISOString().split('T')[0];

            sorted.forEach(t => {
                counts[t.status]++; const od = t.dueDate && t.dueDate < today && t.status !== 'done';
                cols[t.status].appendChild(createCard(t, od));
            });
            document.getElementById('count-todo').innerText = counts.todo; document.getElementById('count-doing').innerText = counts.doing; document.getElementById('count-done').innerText = counts.done;
            const total = activeTasks.length; const p = total === 0 ? 0 : Math.round((counts.done / total) * 100);
            document.getElementById('progress-text').innerText = `${p}%`; 
            document.getElementById('progress-bar').style.strokeDashoffset = 100 - p;
            lucide.createIcons();
        }

        function createCard(t, od) {
            const d = document.createElement('div'); const act = t.status === 'doing'; const exp = expandedTasks.has(t.id);
            const catObj = categories.find(c => c.name === t.category); const catColor = catObj ? catObj.color : '#64748b';
            const recurIcon = t.repeat && t.repeat !== 'none' ? `<i data-lucide="repeat" class="w-3 h-3 text-slate-400 ml-1 inline-block"></i>` : '';
            
            const tagHtml = t.tags && t.tags.length ? `<div class="flex flex-wrap gap-2 mt-3">${t.tags.map(tag => `<span class="px-2 py-1 rounded-lg text-[10px] bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 font-bold uppercase tracking-wide">#${tag}</span>`).join('')}</div>` : '';

            d.className = `modern-card p-5 relative group animate-slide-up mb-4 ${od ? 'border-l-4 border-l-rose-500' : ''} ${act ? 'ring-2 ring-brand-500/50' : ''}`;
            d.draggable = true; d.ondragstart = (e) => { e.dataTransfer.setData("text", t.id); e.target.classList.add('opacity-50'); }; d.ondragend = (e) => { e.target.classList.remove('opacity-50'); };
            
            const done = t.subtasks ? t.subtasks.filter(s => s.completed).length : 0; const total = t.subtasks ? t.subtasks.length : 0; const prog = total === 0 ? 0 : Math.round((done/total)*100);
            let dh = ''; if(t.dueDate) { const date = new Date(t.dueDate); date.setMinutes(date.getMinutes() + date.getTimezoneOffset()); const s = date.toLocaleDateString('pt-BR', {day:'2-digit', month:'short'}); dh = `<div class="flex items-center gap-1.5 text-xs font-bold mt-2 w-fit ${od ? 'text-rose-500 bg-rose-50 px-2 py-1 rounded-lg' : 'text-slate-400'}"><i data-lucide="${od ? 'alert-circle' : 'calendar'}" class="w-3.5 h-3.5"></i> <span>${s}</span></div>`; }
            
            const prioBadge = {
                low: '<span class="w-2 h-2 rounded-full bg-emerald-500"></span>',
                medium: '<span class="w-2 h-2 rounded-full bg-amber-500"></span>',
                high: '<span class="w-2 h-2 rounded-full bg-rose-500 animate-pulse"></span>'
            };

            let acts = act ? `
                <div class="mt-5 pt-4 border-t border-slate-100 dark:border-slate-700/50 flex gap-2">
                    <button onclick="openPomodoro('${t.id}')" class="flex-1 bg-slate-900 dark:bg-white text-white dark:text-slate-900 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wide shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2"><i data-lucide="play" class="w-3 h-3 fill-current"></i> Focar</button>
                    <button onclick="completeTask(event, '${t.id}')" class="bg-emerald-100 text-emerald-600 dark:bg-emerald-500/20 dark:text-emerald-400 w-10 h-10 flex items-center justify-center rounded-xl hover:bg-emerald-200 transition-colors"><i data-lucide="check" class="w-5 h-5"></i></button>
                </div>` : `
                <div class="absolute top-4 right-4 flex gap-1 opacity-0 group-hover:opacity-100 transition-all transform translate-x-2 group-hover:translate-x-0">
                    <button onclick="editTask('${t.id}')" class="p-2 bg-slate-100 dark:bg-slate-700 hover:bg-white dark:hover:bg-slate-600 rounded-xl text-slate-400 shadow-sm transition-colors"><i data-lucide="edit-2" class="w-3.5 h-3.5"></i></button>
                    <button onclick="requestDelete(event, '${t.id}')" class="p-2 bg-slate-100 dark:bg-slate-700 hover:bg-rose-50 dark:hover:bg-rose-900/30 text-slate-400 hover:text-rose-500 rounded-xl shadow-sm transition-colors"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                </div>`;

            d.innerHTML = `
                <div class="flex flex-col h-full">
                    <div onclick="toggleSubtaskList(event, '${t.id}')" class="cursor-pointer flex-1">
                        <div class="flex justify-between items-center mb-2">
                            <span class="inline-flex items-center gap-2 px-2.5 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider text-slate-500 bg-slate-100 dark:bg-slate-800 dark:text-slate-400">
                                ${prioBadge[t.priority]} ${t.category}
                            </span>
                        </div>
                        <h3 class="font-bold text-slate-800 dark:text-white text-base leading-snug pr-8 mb-1">${t.title} ${recurIcon}</h3>
                        ${dh}
                        ${tagHtml}
                        ${total > 0 ? `<div class="mt-4 bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl"><div class="flex justify-between text-[10px] font-bold text-slate-400 mb-1.5 uppercase"><span>Progresso</span><span>${prog}%</span></div><div class="w-full h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden mb-2"><div class="h-full bg-brand-500 rounded-full transition-all duration-500" style="width: ${prog}%"></div></div><button class="w-full text-xs font-bold text-slate-500 flex items-center justify-center gap-1 hover:text-brand-500 transition-colors py-1"><span>${exp?'Ocultar':'Ver'} Etapas (${done}/${total})</span><i data-lucide="chevron-down" class="w-3 h-3 ${exp?'rotate-180':''}"></i></button><div class="${exp?'block':'hidden'} mt-2 space-y-1">${t.subtasks.map((st,i) => `<div class="flex gap-3 items-center p-2 hover:bg-white dark:hover:bg-slate-700 rounded-lg transition-colors cursor-pointer" onclick="event.stopPropagation(); toggleSubtaskCheck('${t.id}',${i})"><div class="w-4 h-4 rounded border-2 ${st.completed ? 'bg-brand-500 border-brand-500' : 'border-slate-300 dark:border-slate-600'} flex items-center justify-center transition-colors"><i data-lucide="check" class="w-3 h-3 text-white ${st.completed ? 'block' : 'hidden'}"></i></div><span class="text-xs font-medium ${st.completed?'line-through text-slate-400':'text-slate-600 dark:text-slate-300'}">${st.title}</span></div>`).join('')}</div></div>` : ''}
                    </div>
                    ${!act ? acts : ''} ${act ? acts : ''}
                </div>`;
            return d;
        }

        function toggleSubtaskList(e, id) { e.stopPropagation(); expandedTasks.has(id) ? expandedTasks.delete(id) : expandedTasks.add(id); renderBoard(); }
        function toggleSubtaskCheck(id, idx) { const t = tasks.find(x => x.id === id); if(t && t.subtasks) { t.subtasks[idx].completed = !t.subtasks[idx].completed; saveTasks(); } }
        
        function openModal(id = null) {
            const m = document.getElementById('task-modal'); m.classList.remove('hidden'); currentEditingId = id; tempSubtasks = [];
            const form = document.getElementById('task-form');
            renderTaskModalCategories(); 
            if(id) {
                const t = tasks.find(x => x.id === id);
                document.getElementById('modal-title').innerText = "Editar Tarefa";
                document.getElementById('task-title').value = t.title; document.getElementById('task-category').value = t.category;
                document.getElementById('task-due-date').value = t.dueDate || '';
                document.getElementById('task-tags').value = t.tags ? t.tags.join(', ') : '';
                document.getElementById('task-repeat').value = t.repeat || 'none';
                document.getElementsByName('priority').forEach(r => r.checked = r.value === t.priority);
                tempSubtasks = t.subtasks ? [...t.subtasks] : [];
            } else {
                document.getElementById('modal-title').innerText = "Nova Tarefa"; form.reset();
                document.getElementsByName('priority')[1].checked = true;
                document.getElementById('task-repeat').value = 'none';
                document.getElementById('task-tags').value = '';
            }
            renderSubtasks(); document.getElementById('task-title').focus();
        }
        function closeModal() { document.getElementById('task-modal').classList.add('hidden'); }
        function editTask(id) { openModal(id); }
        function addSubtaskToForm() { const v = document.getElementById('new-subtask-input').value.trim(); if(v) { tempSubtasks.push({title:v, completed:false}); document.getElementById('new-subtask-input').value=''; renderSubtasks(); } }
        function removeSubtask(idx) { tempSubtasks.splice(idx,1); renderSubtasks(); }
        function renderSubtasks() { document.getElementById('subtask-list-form').innerHTML = tempSubtasks.map((s,i) => `<li class="flex justify-between items-center text-sm font-medium bg-slate-50 dark:bg-slate-800 px-4 py-3 rounded-xl border border-slate-100 dark:border-slate-700"><span class="text-slate-600 dark:text-slate-300">${s.title}</span><button type="button" onclick="removeSubtask(${i})" class="text-rose-400 hover:text-rose-500"><i data-lucide="x" class="w-4 h-4"></i></button></li>`).join(''); lucide.createIcons(); }
        
        function saveTask(e) { 
            e.preventDefault(); 
            const tagsInput = document.getElementById('task-tags').value;
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t.length > 0) : [];

            const data = { 
                title: document.getElementById('task-title').value, 
                category: document.getElementById('task-category').value, 
                dueDate: document.getElementById('task-due-date').value, 
                priority: document.querySelector('input[name="priority"]:checked').value, 
                subtasks: tempSubtasks, 
                repeat: document.getElementById('task-repeat').value,
                tags: tags 
            }; 
            if(currentEditingId) { 
                const idx = tasks.findIndex(t => t.id === currentEditingId); 
                tasks[idx] = { ...tasks[idx], ...data }; 
            } else { 
                tasks.push({ id: generateId(), status: 'todo', createdAt: new Date().toISOString(), ...data }); 
            } 
            saveTasks(); closeModal(); 
        }
        function allowDrop(e) { e.preventDefault(); }
        function drop(e, status) { e.preventDefault(); const id = e.dataTransfer.getData("text"); const t = tasks.find(x => x.id === id); if(t && t.status !== status) { t.status = status; if(status === 'done') { completeTask(null, id); } else { saveTasks(); } } }

        function openPomodoro(id) { const t = tasks.find(x => x.id === id); document.getElementById('pomo-task-title').innerText = t.title; document.getElementById('btn-motivate').classList.remove('hidden'); document.getElementById('motivation-text').classList.add('hidden'); document.getElementById('pomodoro-modal').classList.remove('hidden'); setTimerDuration(25); isEditingTimer = false; }
        function closePomodoro() { document.getElementById('pomodoro-modal').classList.add('hidden'); stopTimer(); isEditingTimer = false;}
        
        function setTimerDuration(minutes) {
            if(isTimerRunning) stopTimer();
            initialTime = minutes * 60;
            timeLeft = initialTime;
            updateTimerDisplay();
            
            // Visual feedback for buttons
            document.querySelectorAll('.timer-btn').forEach(b => {
                const isSelected = parseInt(b.dataset.time) === minutes;
                if(isSelected) {
                    b.classList.remove('text-white/60', 'hover:bg-white/10', 'hover:text-white');
                    b.classList.add('bg-white', 'text-brand-600', 'shadow-lg');
                } else {
                    b.classList.add('text-white/60', 'hover:bg-white/10', 'hover:text-white');
                    b.classList.remove('bg-white', 'text-brand-600', 'shadow-lg');
                }
            });
        }

        function startTimerEdit() { 
            if(isTimerRunning) stopTimer(); 
            isEditingTimer = true; 
            timerDigits = []; 
            const inp = document.getElementById('hidden-timer-input');
            inp.value = ''; inp.focus(); 
            updateTimerEditUI(); 
            document.getElementById('timer-status').innerText = "Digite o tempo"; 
        }

        function handleTimerInput(e) { 
            if(!isEditingTimer) return; 
            let char = e.data;
            if (!char && e.target.value) char = e.target.value.slice(-1);
            if(char && /[0-9]/.test(char)) { if(timerDigits.length < 4) timerDigits.push(char); } 
            e.target.value = ''; updateTimerEditUI(); 
            if(timerDigits.length === 4) setTimeout(() => document.getElementById('hidden-timer-input').blur(), 300); 
        }

        function updateTimerEditUI() { const d = timerDigits; const str = (d[0]||'0')+(d[1]||'0')+":"+(d[2]||'0')+(d[3]||'0'); document.getElementById('timer-display').innerText = str; }
        function toggleTimer() { isTimerRunning ? stopTimer() : startTimer(); }
        function finishTimerEdit() { 
            if(!isEditingTimer) return; 
            const m = parseInt((timerDigits[0]||'0') + (timerDigits[1]||'0')); 
            const s = parseInt((timerDigits[2]||'0') + (timerDigits[3]||'0')); 
            const t = m*60 + s; 
            if(t > 0) { initialTime = t; timeLeft = t; } else { initialTime = 25*60; timeLeft = initialTime; } 
            isEditingTimer = false; timerDigits = []; updateTimerDisplay(); document.getElementById('timer-status').innerText = "Pronto"; 
        }

        function startTimer() { 
            isTimerRunning = true; 
            document.getElementById('timer-status').innerText = "Foco total"; 
            document.getElementById('btn-toggle-timer').innerHTML = `<i data-lucide="pause" class="w-10 h-10 fill-current ml-0.5"></i>`; 
            lucide.createIcons(); 
            timerInterval = setInterval(() => { 
                if(timeLeft > 0) { 
                    timeLeft--; 
                    updateTimerDisplay(); 
                } else { 
                    stopTimer(); playBeep(); fireConfetti(); 
                    if(navigator.vibrate) navigator.vibrate([100, 50, 100]); 
                    pomoCount++; localStorage.setItem('pomo_count', pomoCount); 
                    document.getElementById('timer-status').innerText = "Ciclo Concluído!"; 
                    document.getElementById('timer-display').classList.add('animate-pulse'); 
                } 
            }, 1000); 
        }
        function stopTimer() { 
            isTimerRunning = false; clearInterval(timerInterval); 
            document.getElementById('timer-status').innerText = "Pausado"; 
            document.getElementById('btn-toggle-timer').innerHTML = `<i data-lucide="play" class="w-10 h-10 fill-current ml-1"></i>`; 
            lucide.createIcons(); 
            document.getElementById('timer-display').classList.remove('animate-pulse'); 
        }
        function resetTimer() { stopTimer(); timeLeft = initialTime; updateTimerDisplay(); }
        function updateTimerDisplay() { 
            if(isEditingTimer) return; 
            const m = Math.floor(timeLeft/60).toString().padStart(2,'0'); 
            const s = (timeLeft%60).toString().padStart(2,'0'); 
            document.getElementById('timer-display').innerText = m + ":" + s; 
            const circle = document.getElementById('timer-circle'); 
            const dash = circle.r.baseVal.value * 2 * Math.PI; 
            const offset = dash - (timeLeft/initialTime) * dash; 
            circle.style.strokeDashoffset = offset; 
        }
        function fireConfetti() { const c = document.getElementById('confetti'); const ctx = c.getContext('2d'); c.width = window.innerWidth; c.height = window.innerHeight; const p = Array.from({length:100}, () => ({ x: Math.random()*c.width, y: Math.random()*c.height - c.height, color: `hsl(${Math.random()*360},70%,50%)`, size: Math.random()*10+5, speed: Math.random()*5+2 })); function step() { ctx.clearRect(0,0,c.width,c.height); let a = false; p.forEach(i => { i.y += i.speed; i.x += Math.sin(i.y/50); if(i.y < c.height) a = true; ctx.fillStyle = i.color; ctx.fillRect(i.x, i.y, i.size, i.size); }); if(a) requestAnimationFrame(step); } step(); }
    </script>
</body> 
</html>>
