<!DOCTYPE html>
<html lang="pt-BR" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FlowTask">
    <meta name="theme-color" content="#6366f1">
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%236366f1' rx='40'/%3E%3Cpath d='M45 90L90 112.5L135 90L90 67.5L45 90Z' fill='white' stroke='white' stroke-width='4'/%3E%3Cpath d='M45 110L90 132.5L135 110' stroke='white' stroke-width='8' fill='none'/%3E%3Cpath d='M45 130L90 152.5L135 130' stroke='white' stroke-width='8' fill='none'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%236366f1' rx='40'/%3E%3Cpath d='M45 90L90 112.5L135 90L90 67.5L45 90Z' fill='white' stroke='white' stroke-width='4'/%3E%3Cpath d='M45 110L90 132.5L135 110' stroke='white' stroke-width='8' fill='none'/%3E%3Cpath d='M45 130L90 152.5L135 130' stroke='white' stroke-width='8' fill='none'/%3E%3C/svg%3E">
    
    <title>FlowTask v2.0 Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        brand: {
                            50: 'rgb(var(--color-brand-50) / <alpha-value>)',
                            100: 'rgb(var(--color-brand-100) / <alpha-value>)',
                            500: 'rgb(var(--color-brand-500) / <alpha-value>)',
                            600: 'rgb(var(--color-brand-600) / <alpha-value>)',
                            700: 'rgb(var(--color-brand-700) / <alpha-value>)',
                        },
                        dark: { 800: '#1e293b', 900: '#0f172a' }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'slide-in': 'slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'shimmer': 'shimmer 2s linear infinite',
                        'pop': 'popIn 0.2s cubic-bezier(0.16, 1, 0.3, 1)',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        slideIn: { '0%': { transform: 'translateX(-20px)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
                        shimmer: { '0%': { backgroundPosition: '-200% 0' }, '100%': { backgroundPosition: '200% 0' } },
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --color-brand-50: 238 242 255;
            --color-brand-100: 224 231 255;
            --color-brand-500: 99 102 241;
            --color-brand-600: 79 70 229;
            --color-brand-700: 67 56 202;
            --bg-gradient-from: #6366f1;
            --bg-gradient-to: #a855f7;
            --bg-solid: transparent; /* Novo: Cor s√≥lida de fundo */
            --ui-radius: 0.75rem; 
            --ui-font-scale: 1;
        }

        body { 
            transition: background-color 0.3s ease; 
            -webkit-tap-highlight-color: transparent; 
            font-size: calc(16px * var(--ui-font-scale));
            overscroll-behavior-y: none;
            background-color: var(--bg-solid);
        }

        .rounded-dynamic { border-radius: var(--ui-radius) !important; }
        
        /* LIQUID GLASS APPLE STYLE */
        .glass { 
            background: rgba(255, 255, 255, 0.65); 
            backdrop-filter: blur(20px) saturate(180%); 
            -webkit-backdrop-filter: blur(20px) saturate(180%); 
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        .dark .glass { 
            background: rgba(30, 41, 59, 0.5); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }

        .glass-btn {
            background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.1) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.4);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .glass-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(var(--color-brand-500), 0.3);
            border-color: rgba(var(--color-brand-500), 0.5);
        }
        .glass-btn:active { transform: scale(0.96); }

        .glass-card { 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(16px) saturate(120%); 
            border: 1px solid rgba(255, 255, 255, 0.6); 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); 
            will-change: transform, opacity; 
            border-radius: var(--ui-radius); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .dark .glass-card { 
            background: rgba(30, 41, 59, 0.7); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }
        .glass-card:active { transform: scale(0.98); }
        @media (min-width: 768px) { 
            .glass-card:hover { 
                transform: translateY(-5px) scale(1.01); 
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); 
                z-index: 10; 
                border-color: rgba(var(--color-brand-500), 0.3);
            } 
            .glass-card:active { transform: scale(1); } 
        }

        .form-input-fixed { height: 42px !important; min-height: 42px; max-height: 42px; padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .appearance-none { -webkit-appearance: none; appearance: none; }
        .dark input[type="date"] { color-scheme: dark; }
        .task-overdue { border-left: 4px solid #f43f5e !important; background: linear-gradient(to right, rgba(244, 63, 94, 0.05), transparent); }
        .task-active { border: 2px solid transparent !important; box-shadow: 0 0 0 2px rgba(var(--color-brand-500), 0.3) !important; }
        button, input, select { pointer-events: auto; }
        
        .digit-wrapper { display: inline-block; overflow: hidden; vertical-align: bottom; height: 1.1em; }
        .digit { display: inline-block; animation: fallIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .progress-ring__circle { transition: stroke-dashoffset 1s linear; transform: rotate(-90deg); transform-origin: 50% 50%; }
        .btn-ai { background: linear-gradient(90deg, rgb(var(--color-brand-500)), #a855f7, #ec4899); background-size: 200% 100%; animation: shimmer 3s infinite linear; }
        #settings-sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #settings-sidebar.closed { transform: translateX(100%); }
        .snap-x-mandatory { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }

        /* PIN KEYPAD STYLES */
        .pin-btn { width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; user-select: none; }
        .pin-btn:active { background-color: rgba(255,255,255,0.2); }
        .pin-dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid currentColor; transition: all 0.2s; }
        .pin-dot.filled { background-color: currentColor; }
        
        /* Blob & Background */
        .blob-1 { background-color: var(--bg-gradient-from); opacity: 0.3; }
        .blob-2 { background-color: var(--bg-gradient-to); opacity: 0.3; }
        
        /* ZEN MODE GIGANTE */
        .zen-mode #col-todo, .zen-mode #col-done, .zen-mode header, .zen-mode #stats-bar { display: none !important; }
        .zen-mode #view-kanban { overflow: visible !important; display: flex; align-items: center; justify-content: center; height: 100vh; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 50; background: var(--bg-solid); backdrop-filter: blur(10px); padding: 2rem; }
        .zen-mode .blob-1, .zen-mode .blob-2 { opacity: 0.1; }
        .zen-mode #col-doing { width: 100% !important; max-width: 800px; height: auto; max-height: 90vh; border: none; background: transparent; box-shadow: none; }
        .zen-mode #col-doing .glass-card { transform: scale(1.1); margin-bottom: 2rem; border: 1px solid rgba(var(--color-brand-500), 0.3); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .zen-mode #col-doing h2 { font-size: 2rem; text-align: center; margin-bottom: 2rem; justify-content: center; }
        .zen-mode #zen-exit-btn { display: flex !important; }

        #pin-screen { backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); z-index: 9999; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 min-h-screen selection:bg-brand-500 selection:text-white overflow-hidden transition-colors duration-500 pt-[env(safe-area-inset-top)]">
    
    <div id="pin-screen" class="fixed inset-0 bg-slate-200/90 dark:bg-slate-900/95 flex flex-col items-center justify-center hidden">
        <div class="flex-1 flex flex-col items-center justify-center w-full max-w-sm">
            <div class="mb-8 flex flex-col items-center animate-slide-up">
                <div class="p-4 bg-brand-600 rounded-2xl shadow-xl mb-4"><i data-lucide="lock" class="w-8 h-8 text-white"></i></div>
                <h2 class="text-xl font-bold tracking-wide">Bloqueado</h2>
                <p class="text-slate-500 text-sm mt-1">Digite seu PIN para acessar</p>
            </div>
            <div class="flex gap-4 mb-10 h-4" id="pin-dots">
                <div class="pin-dot text-slate-800 dark:text-white" id="dot-0"></div>
                <div class="pin-dot text-slate-800 dark:text-white" id="dot-1"></div>
                <div class="pin-dot text-slate-800 dark:text-white" id="dot-2"></div>
                <div class="pin-dot text-slate-800 dark:text-white" id="dot-3"></div>
            </div>
            <div class="grid grid-cols-3 gap-x-6 gap-y-4 mb-8">
                <div class="pin-btn hover:bg-black/5 dark:hover:bg-white/10" onclick="pinPress(1)">1</div>
                <div class="pin-btn hover:bg-black/5 dark:hover:bg-white/10" onclick="pinPress(2)">2</div>
                <div class="pin-btn hover:bg-black/5 dark:hover:bg-white/10" onclick="pinPress(3)">3</div>
                <div class="pin-btn hover:bg-black/5 dark:hover:bg-white/10" onclick="pinPress(4)">4</div>
                <div class="pin-btn hover:bg-black/5 dark:hover:bg-white/10" onclick="pinPress(5)">5</div>
                <div class="pin-btn hover:bg-black/5 dark:hover:bg-white/10" onclick="pinPress(6)">6</div>
                <div class="pin-btn hover:bg-black/5 dark:hover:bg-white/10" onclick="pinPress(7)">7</div>
                <div class="pin-btn hover:bg-black/5 dark:hover:bg-white/10" onclick="pinPress(8)">8</div>
                <div class="pin-btn hover:bg-black/5 dark:hover:bg-white/10" onclick="pinPress(9)">9</div>
                <div class="pin-btn opacity-0 cursor-default"></div> <div class="pin-btn hover:bg-black/5 dark:hover:bg-white/10" onclick="pinPress(0)">0</div>
                <div class="pin-btn hover:bg-black/5 dark:hover:bg-white/10 flex items-center justify-center" onclick="pinDelete()"><i data-lucide="delete" class="w-6 h-6"></i></div>
            </div>
            <button onclick="localStorage.removeItem('flowtask_pin'); location.reload();" class="text-xs text-slate-400 mt-4 hover:text-brand-500">Esqueci meu PIN (Resetar)</button>
        </div>
    </div>

    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden" id="bg-container">
        <div class="blob-1 absolute top-0 left-0 w-[800px] h-[800px] rounded-full blur-[120px] mix-blend-multiply dark:mix-blend-screen animate-pulse-slow"></div>
        <div class="blob-2 absolute bottom-0 right-0 w-[600px] h-[600px] rounded-full blur-[120px] mix-blend-multiply dark:mix-blend-screen animate-pulse-slow" style="animation-delay: 2s;"></div>
    </div>

    <div id="offline-indicator" class="fixed top-0 left-0 w-full bg-rose-500 text-white text-xs font-bold text-center py-1 z-[100] hidden">Voc√™ est√° offline. A IA n√£o funcionar√°.</div>

    <button id="zen-exit-btn" onclick="toggleZenMode()" class="hidden fixed top-6 right-6 z-[60] bg-white/20 hover:bg-white/30 text-white px-6 py-3 rounded-full backdrop-blur-md font-bold shadow-2xl transition-all hover:scale-105 active:scale-95 border border-white/20 items-center gap-2">
        <i data-lucide="minimize-2"></i> Sair do Modo Foco
    </button>

    <div class="relative z-10 flex flex-col h-screen max-w-7xl mx-auto p-4 md:p-6 gap-4">
        
        <header class="flex flex-col gap-4 shrink-0">
            <div class="glass rounded-dynamic px-5 py-3 flex justify-between items-center shadow-sm">
                <div class="flex items-center gap-4 overflow-hidden">
                    <div class="relative group cursor-pointer" onclick="document.getElementById('avatar-input').click()">
                        <div id="user-avatar" class="w-10 h-10 rounded-full bg-brand-100 dark:bg-brand-900/50 flex items-center justify-center text-lg shadow-inner overflow-hidden border-2 border-white dark:border-slate-700">üë§</div>
                        <input type="file" id="avatar-input" class="hidden" accept="image/*" onchange="handleAvatarUpload(this)">
                        <div class="absolute inset-0 bg-black/30 rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-white text-[10px] font-bold">Mudar</div>
                    </div>

                    <div class="flex flex-col">
                        <h1 class="text-lg font-bold tracking-tight leading-none flex items-center gap-2">
                             <span id="greeting-text">Ol√°</span>
                             <span class="text-brand-500 text-xs align-top px-1.5 py-0.5 bg-brand-50 dark:bg-brand-900/30 rounded-full">Pro</span>
                        </h1>
                        <p id="date-display" class="text-[10px] text-slate-500 dark:text-slate-400 font-medium capitalize truncate leading-tight mt-0.5"></p>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <button onclick="openTrashModal()" class="p-2 text-slate-400 hover:text-rose-500 transition-colors" title="Lixeira">
                        <i data-lucide="trash" class="w-4 h-4"></i>
                    </button>
                    <div class="hidden sm:block text-xs font-medium text-brand-600 dark:text-brand-400 bg-brand-50 dark:bg-brand-900/20 px-3 py-1 rounded-full border border-brand-100 dark:border-brand-900/50">
                        Modo Produtivo
                    </div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-3">
                <div class="relative flex-1 group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-lucide="search" class="w-4 h-4 text-slate-400 group-focus-within:text-brand-500 transition-colors"></i>
                    </div>
                    <input type="text" id="search-input" onkeyup="renderBoard()" placeholder="O que voc√™ procura hoje?" class="w-full h-11 bg-white/60 dark:bg-slate-800/60 backdrop-blur-md border border-slate-200 dark:border-slate-700/50 rounded-dynamic pl-10 pr-4 text-sm focus:ring-2 focus:ring-brand-500 outline-none transition-all shadow-sm hover:shadow-md hover:bg-white dark:hover:bg-slate-800">
                </div>

                <div class="flex items-center justify-between md:justify-end gap-2 shrink-0">
                    <div class="flex gap-2">
                        <button onclick="toggleZenMode()" id="zen-btn" class="glass-btn h-11 w-11 flex items-center justify-center rounded-dynamic text-slate-600 dark:text-slate-300" title="Modo Zen Gigante">
                            <i data-lucide="maximize-2" class="w-5 h-5"></i>
                        </button>
                        <button onclick="toggleStats()" class="glass-btn h-11 w-11 flex items-center justify-center rounded-dynamic text-slate-600 dark:text-slate-300" title="Hist√≥rico e Stats">
                            <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                        </button>
                        <button onclick="toggleSettings()" class="glass-btn h-11 w-11 flex items-center justify-center rounded-dynamic text-slate-600 dark:text-slate-300" title="Ajustes">
                            <i data-lucide="settings-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    <div class="w-px h-8 bg-slate-300 dark:bg-slate-700 mx-1 hidden md:block"></div>

                    <button onclick="openModal()" class="glass-btn h-11 px-5 bg-gradient-to-r from-brand-600 to-purple-600 hover:from-brand-500 hover:to-purple-500 text-white rounded-dynamic font-medium shadow-lg shadow-brand-600/30 flex items-center gap-2 border-0">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        <span>Nova</span>
                    </button>
                </div>
            </div>
        </header>

        <div id="stats-bar" class="glass rounded-dynamic p-4 shrink-0 flex flex-col sm:flex-row items-center justify-between gap-4 animate-slide-up">
            <div class="flex flex-col w-full">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-sm font-bold text-slate-600 dark:text-slate-300 flex items-center gap-2"><i data-lucide="target" class="w-4 h-4 text-brand-500"></i> Progresso Di√°rio</span>
                    <span id="progress-text" class="text-xl font-bold text-brand-600 dark:text-brand-500">0%</span>
                </div>
                <div class="w-full h-2.5 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden shadow-inner">
                    <div id="progress-bar" class="h-full bg-gradient-to-r from-brand-500 to-purple-500 rounded-full transition-all duration-1000 w-0 relative overflow-hidden">
                        <div class="absolute inset-0 bg-white/20 animate-[shimmer_2s_infinite]"></div>
                    </div>
                </div>
            </div>
            <div class="flex w-full sm:w-auto justify-between sm:justify-start gap-2 text-sm font-medium sm:border-l border-slate-200 dark:border-slate-700 sm:pl-6">
                 <div class="bg-slate-100 dark:bg-slate-800/50 rounded-lg px-3 py-2 text-center min-w-[70px]"><p id="count-todo" class="text-lg font-bold text-slate-700 dark:text-white leading-none">0</p><p class="text-[9px] text-slate-400 uppercase tracking-wider mt-1">A Fazer</p></div>
                <div class="bg-emerald-50 dark:bg-emerald-900/10 rounded-lg px-3 py-2 text-center min-w-[70px] border border-emerald-100 dark:border-emerald-900/20"><p id="count-doing" class="text-lg font-bold text-brand-600 dark:text-brand-400 leading-none">0</p><p class="text-[9px] text-brand-400/80 uppercase tracking-wider mt-1">Focando</p></div>
                <div class="bg-emerald-50 dark:bg-emerald-900/10 rounded-lg px-3 py-2 text-center min-w-[70px] border border-emerald-100 dark:border-emerald-900/20"><p id="count-done" class="text-lg font-bold text-emerald-600 dark:text-emerald-400 leading-none">0</p><p class="text-[9px] text-emerald-400/80 uppercase tracking-wider mt-1">Feito</p></div>
            </div>
        </div>

        <div id="view-kanban" class="flex-1 overflow-x-auto overflow-y-hidden pb-4 -mx-4 px-4 md:mx-0 md:px-0 snap-x-mandatory custom-scrollbar transition-opacity duration-300">
            <div class="flex gap-4 md:gap-6 h-full w-max md:w-full md:min-w-0">
                <div class="flex flex-col w-[85vw] md:w-auto md:flex-1 min-w-[300px] bg-slate-100/60 dark:bg-slate-900/40 rounded-dynamic border border-white/50 dark:border-white/5 backdrop-blur-sm snap-center shadow-inner">
                    <div class="p-4 pb-2 border-b border-black/5 dark:border-white/5"><h2 class="font-bold text-slate-600 dark:text-slate-300 flex items-center gap-2 text-sm uppercase tracking-wide"><div class="w-2 h-2 rounded-full bg-slate-400 ring-2 ring-slate-200 dark:ring-slate-700"></div> A Fazer</h2></div>
                    <div id="col-todo" class="p-3 flex-1 overflow-y-auto space-y-3 custom-scrollbar" ondrop="drop(event, 'todo')" ondragover="allowDrop(event)"></div>
                </div>
                <div class="flex flex-col w-[85vw] md:w-auto md:flex-1 min-w-[300px] bg-brand-50/50 dark:bg-slate-900/40 rounded-dynamic border border-brand-200/30 dark:border-brand-500/10 backdrop-blur-sm snap-center shadow-inner relative">
                    <div class="p-4 pb-2 border-b border-brand-200/30 dark:border-white/5"><h2 class="font-bold text-brand-600 dark:text-brand-400 flex items-center gap-2 text-sm uppercase tracking-wide"><span class="relative flex h-2.5 w-2.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-brand-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-brand-500"></span></span> Em Foco</h2></div>
                    <div id="col-doing" class="p-3 flex-1 overflow-y-auto space-y-3 custom-scrollbar" ondrop="drop(event, 'doing')" ondragover="allowDrop(event)"></div>
                </div>
                <div class="flex flex-col w-[85vw] md:w-auto md:flex-1 min-w-[300px] bg-slate-100/60 dark:bg-slate-900/40 rounded-dynamic border border-white/50 dark:border-white/5 backdrop-blur-sm snap-center shadow-inner">
                    <div class="p-4 pb-2 flex justify-between items-center border-b border-black/5 dark:border-white/5">
                        <h2 class="font-bold text-emerald-600 dark:text-emerald-400 flex items-center gap-2 text-sm uppercase tracking-wide"><div class="w-2 h-2 rounded-full bg-emerald-500 ring-2 ring-emerald-200 dark:ring-emerald-900"></div> Feito</h2>
                        <button onclick="clearDoneTasks()" class="text-[10px] text-slate-400 hover:text-rose-500 uppercase tracking-wider flex items-center gap-1 transition-colors hover:bg-rose-50 dark:hover:bg-rose-900/20 px-2 py-1 rounded" title="Limpar tarefas conclu√≠das"><i data-lucide="archive" class="w-3 h-3"></i> Arquivar</button>
                    </div>
                    <div id="col-done" class="p-3 flex-1 overflow-y-auto space-y-3 custom-scrollbar" ondrop="drop(event, 'done')" ondragover="allowDrop(event)"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-sidebar" class="fixed top-0 right-0 h-full w-80 bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl border-l border-slate-200 dark:border-slate-800 shadow-2xl z-[80] closed p-6 flex flex-col overflow-y-auto custom-scrollbar pt-[calc(env(safe-area-inset-top)+20px)]">
        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-2"><i data-lucide="sliders-horizontal" class="w-5 h-5 text-brand-600 dark:text-brand-400"></i><h2 class="text-xl font-bold text-slate-800 dark:text-white">Ajustes</h2></div>
            <button onclick="toggleSettings()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors"><i data-lucide="x"></i></button>
        </div>
        
        <div class="space-y-8 flex-1">
             <section>
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Apar√™ncia</h3>
                <div class="flex items-center justify-between mb-4 bg-slate-50 dark:bg-slate-800 p-2 rounded-xl">
                     <span class="text-sm font-medium text-slate-700 dark:text-slate-300 ml-2">Modo Escuro</span>
                     <button id="theme-toggle" class="p-2 rounded-lg bg-white dark:bg-slate-700 shadow-sm border border-slate-200 dark:border-slate-600">
                        <i data-lucide="moon" class="w-4 h-4 text-slate-600 dark:text-slate-300 hidden dark:block"></i>
                        <i data-lucide="sun" class="w-4 h-4 text-slate-600 dark:text-slate-300 block dark:hidden"></i>
                     </button>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Cor de Destaque</label>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="setBrandColor('#6366f1')" class="w-8 h-8 rounded-full bg-[#6366f1] ring-2 ring-offset-2 ring-transparent focus:ring-slate-400 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="setBrandColor('#ec4899')" class="w-8 h-8 rounded-full bg-[#ec4899] ring-2 ring-offset-2 ring-transparent focus:ring-slate-400 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="setBrandColor('#10b981')" class="w-8 h-8 rounded-full bg-[#10b981] ring-2 ring-offset-2 ring-transparent focus:ring-slate-400 hover:scale-110 transition-transform shadow-sm"></button>
                        <button onclick="setBrandColor('#f59e0b')" class="w-8 h-8 rounded-full bg-[#f59e0b] ring-2 ring-offset-2 ring-transparent focus:ring-slate-400 hover:scale-110 transition-transform shadow-sm"></button>
                        <input type="color" onchange="setBrandColor(this.value)" class="w-8 h-8 rounded-full overflow-hidden cursor-pointer border-0 p-0">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Cor de Fundo (S√≥lida)</label>
                    <div class="flex items-center gap-3 bg-slate-50 dark:bg-slate-800 p-2 rounded-xl border border-slate-200 dark:border-slate-700">
                        <input type="color" id="bg-color-picker" class="w-8 h-8 rounded-lg cursor-pointer border-0 p-0" oninput="setBackgroundColor(this.value)">
                        <span class="text-xs text-slate-500">Selecione uma cor para substituir o gradiente</span>
                        <button onclick="resetBackground()" class="text-xs text-rose-500 font-bold hover:underline">Reset</button>
                    </div>
                </div>
            </section>

            <hr class="border-slate-200 dark:border-slate-800">

            <section>
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Seguran√ßa</h3>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Bloqueio por PIN</span>
                    <button id="btn-set-pin" onclick="setupPin()" class="glass-btn px-3 py-1.5 rounded-lg text-xs font-bold text-brand-600 dark:text-brand-400 transition-colors">Configurar</button>
                </div>
            </section>

             <section>
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Papel de Parede</h3>
                <label class="block w-full cursor-pointer">
                    <div class="flex items-center justify-center gap-2 w-full py-2 bg-slate-100 dark:bg-slate-800 rounded-lg border border-dashed border-slate-300 dark:border-slate-700 hover:border-brand-500 transition-colors">
                        <i data-lucide="image" class="w-4 h-4 text-slate-500"></i>
                        <span class="text-xs font-medium text-slate-600 dark:text-slate-400">Carregar Imagem</span>
                    </div>
                    <input type="file" class="hidden" accept="image/*" onchange="handleWallpaperUpload(this)">
                </label>
                <button onclick="clearWallpaper()" class="mt-2 text-[10px] text-rose-500 hover:underline w-full text-center">Remover Wallpaper</button>
            </section>

            <hr class="border-slate-200 dark:border-slate-800">

            <section>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Categorias</h3>
                    <button onclick="addCategory()" class="text-xs bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 px-2 py-1 rounded hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">+ Nova</button>
                </div>
                <div id="categories-list" class="space-y-3"></div>
            </section>

            <hr class="border-slate-200 dark:border-slate-800">

            <div id="pwa-install-area" class="hidden">
                <button onclick="installPWA()" class="w-full bg-slate-900 dark:bg-white text-white dark:text-slate-900 py-3 rounded-dynamic font-bold flex items-center justify-center gap-2 shadow-lg hover:opacity-90 transition-opacity">
                    <i data-lucide="download" class="w-4 h-4"></i> Instalar App
                </button>
                <hr class="border-slate-200 dark:border-slate-800 mt-6">
            </div>

            <section>
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Dados</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="exportData()" class="flex items-center justify-center gap-2 py-2 px-4 bg-slate-100 dark:bg-slate-800 rounded-lg text-xs font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                        <i data-lucide="upload" class="w-3 h-3"></i> Backup
                    </button>
                    <label class="flex items-center justify-center gap-2 py-2 px-4 bg-slate-100 dark:bg-slate-800 rounded-lg text-xs font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors cursor-pointer">
                        <i data-lucide="download" class="w-3 h-3"></i> Restaurar
                        <input type="file" class="hidden" onchange="importData(this)">
                    </label>
                </div>
            </section>
        </div>
        <div class="text-center text-[10px] text-slate-400 mt-auto pt-6">FlowTask Pro v2.0</div>
    </div>
    <div id="settings-overlay" onclick="toggleSettings()" class="fixed inset-0 bg-black/20 backdrop-blur-sm z-[75] hidden transition-opacity"></div>

    <div id="stats-modal" class="fixed inset-0 z-[65] hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="toggleStats()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="glass bg-white dark:bg-slate-900 w-full max-w-lg rounded-dynamic shadow-2xl p-6 transform transition-all animate-pop max-h-[90vh] overflow-y-auto custom-scrollbar">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="activity" class="text-brand-500"></i> Hist√≥rico & Stats</h2>
                    <button onclick="toggleStats()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i data-lucide="x"></i></button>
                </div>
                
                <div id="stats-content" class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl text-center border border-slate-100 dark:border-slate-700">
                             <span class="block text-3xl font-bold text-brand-600" id="stat-completion-rate">0%</span>
                             <span class="text-xs text-slate-500 uppercase font-bold tracking-wider">Taxa Conclus√£o</span>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl text-center border border-slate-100 dark:border-slate-700">
                             <span class="block text-3xl font-bold text-emerald-600" id="stat-pomodoros">0</span>
                             <span class="text-xs text-slate-500 uppercase font-bold tracking-wider">Ciclos Foco</span>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">√öltimos 7 Dias (Conclu√≠das)</h4>
                        <div class="h-40 w-full">
                            <canvas id="historyChart"></canvas>
                        </div>
                    </div>

                    <div id="stats-categories-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="trash-modal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeTrashModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="glass bg-white dark:bg-slate-900 w-full max-w-md rounded-dynamic shadow-2xl p-6 transform transition-all animate-pop h-[500px] flex flex-col">
                <div class="flex justify-between items-center mb-4 shrink-0">
                    <h2 class="text-xl font-bold text-rose-500 flex items-center gap-2"><i data-lucide="trash-2"></i> Lixeira (24h)</h2>
                    <button onclick="closeTrashModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button>
                </div>
                <div class="text-xs text-slate-400 mb-4 shrink-0">Tarefas nesta lista ser√£o exclu√≠das permanentemente ap√≥s 24 horas.</div>
                <div id="trash-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-3 p-1"></div>
            </div>
        </div>
    </div>

    <div id="task-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="glass bg-white dark:bg-slate-900 w-full max-w-lg rounded-dynamic shadow-2xl p-6 transform transition-all animate-pop max-h-[90vh] overflow-y-auto custom-scrollbar">
                <div class="flex justify-between items-center mb-6"><h2 id="modal-title" class="text-xl font-bold">Nova Tarefa</h2><button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors p-2"><i data-lucide="x"></i></button></div>
                <form id="task-form" onsubmit="saveTask(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">T√≠tulo da Tarefa</label>
                            <input type="text" id="task-title" required class="w-full form-input-fixed bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-4 focus:ring-2 focus:ring-brand-500 outline-none dark:text-white transition-all placeholder:text-slate-400" placeholder="Ex: Finalizar relat√≥rio trimestral">
                        </div>
                        <div class="grid grid-cols-2 gap-3 sm:gap-4">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Prazo Final</label><input type="date" id="task-due-date" class="w-full form-input-fixed appearance-none bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 outline-none dark:text-white transition-all cursor-pointer text-sm font-medium" style="min-height: 42px;"></div>
                            <div><label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Categoria</label><select id="task-category" class="w-full form-input-fixed bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 outline-none dark:text-white cursor-pointer transition-all text-sm font-medium"></select></div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider flex items-center gap-1"><i data-lucide="repeat" class="w-3 h-3"></i> Recorr√™ncia üîÑ</label>
                            <select id="task-repeat" class="w-full form-input-fixed bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 outline-none dark:text-white cursor-pointer transition-all text-sm font-medium">
                                <option value="none">N√£o repetir</option>
                                <option value="daily">Diariamente</option>
                                <option value="weekly">Semanalmente</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Prioridade</label>
                            <div class="grid grid-cols-3 gap-2">
                                <label class="cursor-pointer group"><input type="radio" name="priority" value="low" class="peer sr-only"><div class="rounded-lg border border-slate-200 dark:border-slate-700 py-2.5 text-center text-sm font-medium peer-checked:bg-emerald-500 peer-checked:text-white peer-checked:border-emerald-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">Baixa</div></label>
                                <label class="cursor-pointer group"><input type="radio" name="priority" value="medium" class="peer sr-only" checked><div class="rounded-lg border border-slate-200 dark:border-slate-700 py-2.5 text-center text-sm font-medium peer-checked:bg-amber-500 peer-checked:text-white peer-checked:border-amber-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">M√©dia</div></label>
                                <label class="cursor-pointer group"><input type="radio" name="priority" value="high" class="peer sr-only"><div class="rounded-lg border border-slate-200 dark:border-slate-700 py-2.5 text-center text-sm font-medium peer-checked:bg-rose-500 peer-checked:text-white peer-checked:border-rose-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">Alta</div></label>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between items-end mb-1.5"><label class="block text-xs font-bold text-slate-500 uppercase tracking-wider">Checklist</label><button type="button" onclick="generateSubtasks()" id="btn-magic-subtasks" class="text-[10px] btn-ai text-white px-2 py-1 rounded flex items-center gap-1 hover:shadow-lg transition-all transform hover:scale-105 active:scale-95"><i data-lucide="sparkles" class="w-3 h-3"></i> Gerar com IA</button></div>
                            <div class="flex gap-2 mb-2"><input type="text" id="new-subtask-input" class="flex-1 form-input-fixed bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 text-sm outline-none dark:text-white focus:border-brand-500 transition-all" placeholder="Adicionar etapa..." onkeypress="if(event.key === 'Enter'){event.preventDefault(); addSubtaskToForm();}"><button type="button" onclick="addSubtaskToForm()" class="h-[42px] w-[42px] flex items-center justify-center bg-slate-200 dark:bg-slate-700 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors"><i data-lucide="plus" class="w-5 h-5"></i></button></div>
                            <ul id="subtask-list-form" class="space-y-1 max-h-32 overflow-y-auto custom-scrollbar"></ul>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end gap-3 sticky bottom-0 bg-white dark:bg-slate-900 py-2"><button type="button" onclick="closeModal()" class="px-5 py-2.5 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl font-medium transition-colors">Cancelar</button><button type="submit" class="px-6 py-2.5 bg-brand-600 hover:bg-brand-500 text-white rounded-xl font-medium shadow-lg shadow-brand-600/30 transition-all transform active:scale-95 glass-btn border-0">Salvar</button></div>
                </form>
            </div>
        </div>
    </div>

    <div id="pomodoro-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-slate-900/95 backdrop-blur-md flex flex-col items-center justify-center text-white p-4">
            <button onclick="closePomodoro()" class="absolute top-6 right-6 p-2 hover:bg-white/10 rounded-full transition-colors"><i data-lucide="x" class="w-8 h-8"></i></button>
            <div class="mb-4 text-center animate-pop w-full max-w-lg flex flex-col items-center">
                <span class="text-brand-400 font-bold tracking-widest uppercase text-xs border border-brand-500/30 px-3 py-1 rounded-full bg-brand-500/10">Modo Foco</span>
                <h2 id="pomo-task-title" class="text-2xl md:text-3xl font-bold mt-4 mx-auto truncate px-4 w-full"></h2>
                <div class="w-full px-6 mt-4 min-h-[3.5rem] flex items-center justify-center gap-2">
                    <button id="btn-motivate" onclick="generateMotivation()" class="text-xs text-slate-400 hover:text-white flex items-center gap-1.5 bg-white/5 px-4 py-2 rounded-full transition-all hover:bg-white/10 active:scale-95 border border-white/5 hover:border-brand-500/30"><i data-lucide="zap" class="w-3 h-3 text-yellow-400"></i> Motiva√ß√£o</button>
                    <div id="motivation-text" class="hidden text-sm text-brand-100 font-medium italic animate-slide-up w-full text-center bg-brand-500/10 border border-brand-500/20 p-3 rounded-xl shadow-inner relative"><span class="absolute top-1 left-2 text-brand-500/20 text-2xl font-serif">‚Äú</span><span id="motivation-content"></span><span class="absolute bottom-[-0.5rem] right-2 text-brand-500/20 text-2xl font-serif">‚Äù</span></div>
                </div>
            </div>
            <div class="flex gap-2 mb-8 bg-white/5 p-1 rounded-xl overflow-x-auto max-w-full shrink-0">
                <button onclick="setTimerDuration(15)" class="timer-btn px-4 py-1.5 rounded-lg text-sm transition-colors text-slate-300 whitespace-nowrap" data-time="15">15m</button>
                <button onclick="setTimerDuration(25)" class="timer-btn px-4 py-1.5 rounded-lg text-sm bg-brand-600 text-white font-medium shadow-lg whitespace-nowrap" data-time="25">25m</button>
                <button onclick="setTimerDuration(45)" class="timer-btn px-4 py-1.5 rounded-lg text-sm transition-colors text-slate-300 whitespace-nowrap" data-time="45">45m</button>
                <button onclick="setTimerDuration(60)" class="timer-btn px-4 py-1.5 rounded-lg text-sm transition-colors text-slate-300 whitespace-nowrap" data-time="60">60m</button>
            </div>
            <div class="relative w-72 h-72 shrink-0 flex items-center justify-center group/timer">
                <svg class="w-full h-full" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="none" stroke="#1e293b" stroke-width="4" /><circle id="timer-circle" class="progress-ring__circle" cx="50" cy="50" r="45" fill="none" stroke="rgb(var(--color-brand-500))" stroke-width="4" stroke-linecap="round" stroke-dasharray="283" stroke-dashoffset="0" /></svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center z-10">
                    <input type="number" id="hidden-timer-input" class="absolute opacity-0 w-1 h-1 pointer-events-none" inputmode="numeric">
                    <div id="timer-display" class="text-6xl font-bold tracking-tighter font-mono flex items-center justify-center cursor-pointer hover:scale-105 transition-transform relative select-none text-white drop-shadow-lg" title="Clique para digitar o tempo" onclick="startTimerEdit()"></div>
                    <span id="timer-status" class="text-slate-400 mt-4 text-sm font-medium">Pausado</span>
                </div>
            </div>
            <div class="mt-10 flex items-center gap-6">
                <button id="btn-brown-noise" onclick="toggleBrownNoise()" class="w-14 h-14 rounded-full bg-white/5 hover:bg-white/20 flex items-center justify-center text-slate-400 hover:text-white transition-all transform active:scale-95 border border-white/5" title="Ru√≠do Marrom"><i data-lucide="waves" class="w-6 h-6"></i></button>
                <button id="btn-toggle-timer" onclick="toggleTimer()" class="w-20 h-20 rounded-full bg-brand-500 hover:bg-brand-400 flex items-center justify-center shadow-lg shadow-brand-500/50 transition-all transform hover:scale-110 active:scale-95 group"><i data-lucide="play" class="w-8 h-8 fill-current group-hover:fill-white transition-colors"></i></button>
                <button onclick="resetTimer()" class="w-14 h-14 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center border border-white/10 transition-colors text-slate-300 hover:text-white transform active:rotate-180 duration-500"><i data-lucide="rotate-ccw" class="w-6 h-6"></i></button>
            </div>
        </div>
    </div>

    <canvas id="confetti" class="fixed inset-0 pointer-events-none z-[70]"></canvas>

    <script>
        let tasks = [], tempSubtasks = [], currentEditingId = null, taskToDeleteId = null, timerInterval = null, initialTime = 25*60, timeLeft = 25*60, isTimerRunning = false, isEditingTimer = false, timerDigits = [], expandedTasks = new Set(), soundEnabled = true, pomoCount = 0;
        let completionLog = []; // [{date: 'YYYY-MM-DD', taskId: 'ID'}]
        let pwaPrompt;
        let brownNoiseNode = null, noiseContext = null;
        let pinInputBuffer = "";
        let historyChartInstance = null;

        let categories = [
            { id: 'cat_1', name: 'Trabalho', color: '#6366f1' },
            { id: 'cat_2', name: 'Pessoal', color: '#ec4899' },
            { id: 'cat_3', name: 'Estudo', color: '#f59e0b' },
            { id: 'cat_4', name: 'Sa√∫de', color: '#10b981' }
        ];

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep() {
            if(!soundEnabled) return;
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination); o.type = 'sine'; o.frequency.value = 880;
            g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5);
            o.start(); o.stop(audioCtx.currentTime + 0.5);
        }

        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); pwaPrompt = e; document.getElementById('pwa-install-area').classList.remove('hidden'); });
        async function installPWA() { if (pwaPrompt) { pwaPrompt.prompt(); const { outcome } = await pwaPrompt.userChoice; if (outcome === 'accepted') document.getElementById('pwa-install-area').classList.add('hidden'); pwaPrompt = null; } }
        if ('Notification' in window) Notification.requestPermission();
        window.addEventListener('offline', () => document.getElementById('offline-indicator').classList.remove('hidden'));
        window.addEventListener('online', () => document.getElementById('offline-indicator').classList.add('hidden'));
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            if (e.key === 'n' || e.key === 'N') openModal();
            if (e.key === 'Escape') { closeModal(); closeTrashModal(); toggleStats(); toggleSettings(); }
            if (e.key === '/') { e.preventDefault(); document.getElementById('search-input').focus(); }
        });

        document.addEventListener('DOMContentLoaded', () => {
            checkPin();
            loadTasks(); loadCategories(); loadWallpaper(); loadAvatar(); setupTheme(); updateGreeting(); lucide.createIcons(); cleanupTrash();
            const pc = localStorage.getItem('pomo_count'); if(pc) { pomoCount = parseInt(pc); }
            const cl = localStorage.getItem('flowtask_log'); if(cl) { completionLog = JSON.parse(cl); }
            const h = document.getElementById('hidden-timer-input'); h.addEventListener('input', handleTimerInput); h.addEventListener('blur', finishTimerEdit);
        });

        function generateId() { return Math.random().toString(36).substr(2, 9); }
        function loadTasks() { const t = localStorage.getItem('flowtask_tasks'); if(t) { tasks = JSON.parse(t); tasks.forEach(task => { if(!task.subtasks) task.subtasks = []; if(!task.repeat) task.repeat = 'none'; }); } renderBoard(); }
        function saveTasks() { localStorage.setItem('flowtask_tasks', JSON.stringify(tasks)); renderBoard(); }
        function setupTheme() { if(localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark'); }
        document.getElementById('theme-toggle').addEventListener('click', () => { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); });
        
        function updateGreeting() {
            const h = new Date().getHours();
            let g = 'Bom dia'; if (h >= 12 && h < 18) g = 'Boa tarde'; else if (h >= 18) g = 'Boa noite';
            // Pega o nome do localStorage se existir, senao usa vazio
            const name = localStorage.getItem('user_name') || '';
            document.getElementById('greeting-text').innerText = `${g}${name ? ', ' + name : ''}`;
            document.getElementById('date-display').innerText = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
        }
        
        function loadCategories() { const saved = localStorage.getItem('flowtask_categories'); if(saved) categories = JSON.parse(saved); renderCategoriesSettings(); }
        function saveCategories() { localStorage.setItem('flowtask_categories', JSON.stringify(categories)); renderCategoriesSettings(); renderBoard(); }
        function persistCategoriesOnly() { localStorage.setItem('flowtask_categories', JSON.stringify(categories)); renderBoard(); }

        function renderCategoriesSettings() {
            const list = document.getElementById('categories-list');
            list.innerHTML = categories.map(cat => `
                <div class="flex items-center gap-2 group">
                    <div id="cat-color-box-${cat.id}" class="relative w-6 h-6 shrink-0 rounded-full overflow-hidden border border-slate-200 dark:border-slate-700 cursor-pointer shadow-sm transition-transform hover:scale-110" style="background-color: ${cat.color}">
                        <input type="color" value="${cat.color}" onchange="updateCategory('${cat.id}', 'color', this.value)" onclick="event.stopPropagation()" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer p-0 border-0 z-10">
                    </div>
                    <input type="text" value="${cat.name}" onchange="updateCategory('${cat.id}', 'name', this.value)" class="flex-1 bg-transparent text-sm text-slate-700 dark:text-slate-200 border-b border-transparent focus:border-brand-500 outline-none px-1 py-0.5 transition-colors" placeholder="Nome">
                    <button onclick="deleteCategory('${cat.id}')" class="text-slate-400 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function addCategory() { const colors = ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#3b82f6']; categories.push({ id: generateId(), name: 'Nova Categoria', color: colors[Math.floor(Math.random() * colors.length)] }); saveCategories(); }
        function updateCategory(id, field, value) { const cat = categories.find(c => c.id === id); if(cat) { if(field === 'name') { const old = cat.name; cat.name = value; tasks.forEach(t => { if(t.category === old) t.category = value; }); saveTasks(); saveCategories(); } else if (field === 'color') { cat[field] = value; document.getElementById(`cat-color-box-${id}`).style.backgroundColor = value; persistCategoriesOnly(); } } }
        function deleteCategory(id) { if(categories.length <= 1) { alert("M√≠nimo 1 categoria."); return; } if(confirm("Excluir?")) { categories = categories.filter(c => c.id !== id); saveCategories(); } }
        function renderTaskModalCategories() { const s = document.getElementById('task-category'); if(!s) return; s.innerHTML = categories.map(c => `<option value="${c.name}">${c.name}</option>`).join(''); }

        function exportData() { const d = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({tasks, categories, completionLog, pomoCount})); const a = document.createElement('a'); a.setAttribute("href", d); a.setAttribute("download", "flowtask_backup.json"); document.body.appendChild(a); a.click(); a.remove(); }
        function importData(input) { const f = input.files[0]; if (!f) return; const r = new FileReader(); r.onload = (e) => { try { const d = JSON.parse(e.target.result); if(d.tasks) { tasks = d.tasks; saveTasks(); } if(d.categories) { categories = d.categories; saveCategories(); } if(d.completionLog) { completionLog = d.completionLog; localStorage.setItem('flowtask_log', JSON.stringify(completionLog)); } alert("Restaurado!"); location.reload(); } catch (err) { alert("Erro ao importar."); } }; r.readAsText(f); }
        function clearDoneTasks() { if(confirm("Arquivar tarefas conclu√≠das?")) { tasks = tasks.filter(t => t.status !== 'done'); saveTasks(); } }

        function toggleSettings() { document.getElementById('settings-sidebar').classList.toggle('closed'); document.getElementById('settings-overlay').classList.toggle('hidden'); }
        function hexToRgb(hex) { const r = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return r ? `${parseInt(r[1], 16)} ${parseInt(r[2], 16)} ${parseInt(r[3], 16)}` : null; }
        function setBrandColor(hex) { if(!hex.startsWith('#')) hex = '#'+hex; if(!/^#([0-9A-F]{3}){1,2}$/i.test(hex)) return; const rgb = hexToRgb(hex); if(rgb) { document.documentElement.style.setProperty('--color-brand-500', rgb); document.documentElement.style.setProperty('--color-brand-600', rgb); document.documentElement.style.setProperty('--color-brand-50', rgb); document.getElementById('timer-circle').style.stroke = `rgb(${rgb})`; } }
        function setBackgroundColor(hex) { document.documentElement.style.setProperty('--bg-solid', hex); document.getElementById('bg-container').style.display = 'none'; }
        function resetBackground() { document.documentElement.style.setProperty('--bg-solid', 'transparent'); document.getElementById('bg-container').style.display = 'block'; }
        
        async function callGemini(p) { let k = localStorage.getItem('gemini_api_key'); if (!k) { k = prompt("API Key Gemini:"); if (k) localStorage.setItem('gemini_api_key', k); else return null; } try { const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${k}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: p }] }] }) }); if (!r.ok) throw new Error('API Error'); const d = await r.json(); return d.candidates?.[0]?.content?.parts?.[0]?.text; } catch (e) { console.error(e); alert("Erro na IA."); return null; } }
        async function generateSubtasks() { const t = document.getElementById('task-title').value; if(!t) { alert("Digite o t√≠tulo!"); return; } const b = document.getElementById('btn-magic-subtasks'); const old = b.innerHTML; b.innerHTML = `<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Criando...`; b.disabled = true; lucide.createIcons(); const r = await callGemini(`Lista de 3-5 sub-tarefas para: "${t}". Apenas texto.`); if(r) { r.split('\n').filter(l => l.trim().length > 0).forEach(l => { const cl = l.replace(/^[\*\-\d\.]+\s*/, '').trim(); if(cl) tempSubtasks.push({title: cl, completed: false}); }); renderSubtasks(); } b.disabled = false; b.innerHTML = old; lucide.createIcons(); }
        async function generateMotivation() { const t = document.getElementById('pomo-task-title').innerText; const b = document.getElementById('btn-motivate'); const txt = document.getElementById('motivation-text'); const c = document.getElementById('motivation-content'); b.classList.add('hidden'); txt.classList.remove('hidden'); c.innerText = "Gerando..."; const p = `Frase curta motivacional (max 20 palavras) para: "${t}". Sem markdown. Sem asteriscos.`; const r = await callGemini(p); if(r) c.innerText = r.replace(/\*\*/g, '').trim(); else c.innerText = "Foque no agora."; }

        // --- AVATAR LOGIC ---
        function handleAvatarUpload(input) {
            const f = input.files[0];
            if(f) {
                if(f.size > 2000000) { alert("M√°x 2MB"); return; }
                const r = new FileReader();
                r.onload = (e) => {
                    const url = e.target.result;
                    localStorage.setItem('user_avatar', url);
                    loadAvatar();
                };
                r.readAsDataURL(f);
            }
        }
        function loadAvatar() {
            const av = localStorage.getItem('user_avatar');
            const el = document.getElementById('user-avatar');
            if(av) {
                el.innerHTML = `<img src="${av}" class="w-full h-full object-cover">`;
                el.classList.remove('bg-brand-100');
            } else {
                el.innerText = 'üë§';
            }
        }

        // --- PIN LOGIC ---
        function checkPin() { const pin = localStorage.getItem('flowtask_pin'); if(pin) { document.getElementById('pin-screen').classList.remove('hidden'); pinInputBuffer = ""; updatePinDots(); } updatePinButton(); }
        function pinPress(num) {
            if(pinInputBuffer.length < 4) {
                pinInputBuffer += num;
                updatePinDots();
                if(pinInputBuffer.length === 4) { setTimeout(verifyPin, 200); }
            }
        }
        function pinDelete() { if(pinInputBuffer.length > 0) { pinInputBuffer = pinInputBuffer.slice(0, -1); updatePinDots(); } }
        function updatePinDots() { for(let i=0; i<4; i++) { const dot = document.getElementById(`dot-${i}`); if(i < pinInputBuffer.length) dot.classList.add('filled'); else dot.classList.remove('filled'); } }
        function verifyPin() {
            const correct = localStorage.getItem('flowtask_pin');
            if(pinInputBuffer === correct) { document.getElementById('pin-screen').classList.add('hidden'); pinInputBuffer = ""; } 
            else { document.getElementById('pin-dots').classList.add('animate-shake'); setTimeout(() => { document.getElementById('pin-dots').classList.remove('animate-shake'); pinInputBuffer = ""; updatePinDots(); }, 500); }
        }
        function setupPin() { const current = localStorage.getItem('flowtask_pin'); if(current) { if(confirm("Remover PIN de seguran√ßa?")) { localStorage.removeItem('flowtask_pin'); updatePinButton(); } } else { const newPin = prompt("Digite um PIN de 4 n√∫meros:"); if(newPin && newPin.length === 4 && !isNaN(newPin)) { localStorage.setItem('flowtask_pin', newPin); alert("PIN Configurado!"); updatePinButton(); } else if(newPin) { alert("PIN inv√°lido."); } } }
        function updatePinButton() { const btn = document.getElementById('btn-set-pin'); btn.innerText = localStorage.getItem('flowtask_pin') ? 'Remover' : 'Configurar'; }

        // Zen Mode
        function toggleZenMode() { 
            document.body.classList.toggle('zen-mode'); 
            const btn = document.getElementById('zen-btn'); 
            // Update icon style or state if needed
            renderBoard(); // Re-render to ensure layout fits
        }

        // Wallpaper
        function handleWallpaperUpload(input) { const f = input.files[0]; if(f) { if(f.size > 2000000) { alert("Imagem muito grande (Max 2MB)"); return; } const r = new FileReader(); r.onload = (e) => { const url = e.target.result; localStorage.setItem('flowtask_wallpaper', url); loadWallpaper(); }; r.readAsDataURL(f); } }
        function loadWallpaper() { const w = localStorage.getItem('flowtask_wallpaper'); const c = document.getElementById('bg-container'); if(w) { c.innerHTML = `<div class="absolute inset-0 bg-cover bg-center opacity-30 dark:opacity-20" style="background-image: url('${w}')"></div>`; } else { c.innerHTML = `<div class="blob-1 absolute top-0 left-0 w-[800px] h-[800px] rounded-full blur-[120px] mix-blend-multiply dark:mix-blend-screen animate-pulse-slow"></div><div class="blob-2 absolute bottom-0 right-0 w-[600px] h-[600px] rounded-full blur-[120px] mix-blend-multiply dark:mix-blend-screen animate-pulse-slow" style="animation-delay: 2s;"></div>`; } }
        function clearWallpaper() { localStorage.removeItem('flowtask_wallpaper'); loadWallpaper(); }

        // Brown Noise
        function toggleBrownNoise() {
            if (brownNoiseNode) { brownNoiseNode.disconnect(); brownNoiseNode = null; document.getElementById('btn-brown-noise').classList.remove('bg-white/20', 'text-white'); document.getElementById('btn-brown-noise').classList.add('text-slate-400'); } 
            else { if (!noiseContext) noiseContext = new (window.AudioContext || window.webkitAudioContext)(); const bufferSize = 4096; brownNoiseNode = noiseContext.createScriptProcessor(bufferSize, 1, 1); brownNoiseNode.onaudioprocess = function(e) { const output = e.outputBuffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) { const white = Math.random() * 2 - 1; output[i] = (lastOut + (0.02 * white)) / 1.02; lastOut = output[i]; output[i] *= 3.5; } }; let lastOut = 0; brownNoiseNode.connect(noiseContext.destination); document.getElementById('btn-brown-noise').classList.add('bg-white/20', 'text-white'); document.getElementById('btn-brown-noise').classList.remove('text-slate-400'); }
        }

        // --- STATS & HISTORY ---
        function toggleStats() { 
            const m = document.getElementById('stats-modal'); 
            if(m.classList.contains('hidden')) { 
                m.classList.remove('hidden'); 
                renderStats(); 
            } else { 
                m.classList.add('hidden'); 
            } 
        }
        function renderStats() {
            // KPIs
            const total = tasks.filter(t => t.status !== 'trash').length;
            const done = tasks.filter(t => t.status === 'done').length;
            const rate = total ? Math.round((done/total)*100) : 0;
            document.getElementById('stat-completion-rate').innerText = `${rate}%`;
            document.getElementById('stat-pomodoros').innerText = pomoCount;

            // Categories
            const byCat = {}; categories.forEach(c => byCat[c.name] = 0);
            tasks.filter(t => t.status !== 'trash').forEach(t => { if(byCat[t.category] !== undefined) byCat[t.category]++; });
            
            document.getElementById('stats-categories-list').innerHTML = `
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">Tarefas por Categoria</h4>
                <div class="space-y-2">
                    ${Object.entries(byCat).map(([name, count]) => {
                        const cat = categories.find(c => c.name === name);
                        const w = total ? (count/total)*100 : 0;
                        return `<div class="flex items-center gap-2 text-sm"><span class="w-20 truncate text-slate-600 dark:text-slate-300">${name}</span><div class="flex-1 h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden"><div class="h-full" style="width: ${w}%; background-color: ${cat.color}"></div></div><span class="w-6 text-right text-slate-500 text-xs">${count}</span></div>`;
                    }).join('')}
                </div>`;

            // Chart
            const ctx = document.getElementById('historyChart').getContext('2d');
            if(historyChartInstance) historyChartInstance.destroy();
            
            // Get last 7 days labels and data
            const labels = [];
            const data = [];
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                labels.push(d.toLocaleDateString('pt-BR', {weekday: 'short'}));
                data.push(completionLog.filter(l => l.date === dateStr).length);
            }

            historyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tarefas Conclu√≠das',
                        data: data,
                        backgroundColor: 'rgba(99, 102, 241, 0.5)',
                        borderColor: '#6366f1',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- TRASH LOGIC ---
        function cleanupTrash() {
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000;
            // Remove permanently if in trash > 24h
            const initialLen = tasks.length;
            tasks = tasks.filter(t => {
                if(t.status === 'trash' && t.deletedAt) {
                    return (now - t.deletedAt) < oneDay;
                }
                return true;
            });
            if(tasks.length !== initialLen) saveTasks();
        }
        function requestDelete(e, id) { 
            if(e) e.stopPropagation(); 
            // Soft delete
            const t = tasks.find(x => x.id === id);
            if(t) {
                t.status = 'trash';
                t.deletedAt = Date.now();
                saveTasks();
            }
        }
        function restoreTask(id) {
            const t = tasks.find(x => x.id === id);
            if(t) {
                t.status = 'todo';
                delete t.deletedAt;
                saveTasks();
                openTrashModal(); // Refresh list
            }
        }
        function deletePermanently(id) {
            tasks = tasks.filter(t => t.id !== id);
            saveTasks();
            openTrashModal();
        }
        function openTrashModal() {
            document.getElementById('trash-modal').classList.remove('hidden');
            const trashList = document.getElementById('trash-list');
            const deleted = tasks.filter(t => t.status === 'trash');
            
            if(deleted.length === 0) {
                trashList.innerHTML = '<div class="text-center text-slate-400 py-10">Lixeira vazia</div>';
            } else {
                trashList.innerHTML = deleted.map(t => `
                    <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700">
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300 truncate flex-1 pr-2">${t.title}</span>
                        <div class="flex gap-2">
                            <button onclick="restoreTask('${t.id}')" class="text-emerald-500 hover:bg-emerald-50 p-1.5 rounded" title="Restaurar"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
                            <button onclick="deletePermanently('${t.id}')" class="text-rose-500 hover:bg-rose-50 p-1.5 rounded" title="Excluir"><i data-lucide="x" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            }
        }
        function closeTrashModal() { document.getElementById('trash-modal').classList.add('hidden'); }


        // --- BOARD RENDER ---
        function renderBoard() {
            const filter = document.getElementById('search-input').value.toLowerCase();
            const cols = { todo: document.getElementById('col-todo'), doing: document.getElementById('col-doing'), done: document.getElementById('col-done') };
            Object.values(cols).forEach(c => c.innerHTML = '');
            const today = new Date().toISOString().split('T')[0];
            let counts = { todo: 0, doing: 0, done: 0 };
            const w = { high: 3, medium: 2, low: 1 };
            
            // Filter out trash
            const activeTasks = tasks.filter(t => t.status !== 'trash');
            
            const sorted = [...activeTasks].filter(t => t.title.toLowerCase().includes(filter)).sort((a, b) => (w[b.priority] || 0) - (w[a.priority] || 0) || a.title.localeCompare(b.title));
            
            sorted.forEach(t => {
                counts[t.status]++; const od = t.dueDate && t.dueDate < today && t.status !== 'done';
                cols[t.status].appendChild(createCard(t, od));
            });
            document.getElementById('count-todo').innerText = counts.todo; document.getElementById('count-doing').innerText = counts.doing; document.getElementById('count-done').innerText = counts.done;
            const total = activeTasks.length; const p = total === 0 ? 0 : Math.round((counts.done / total) * 100);
            document.getElementById('progress-text').innerText = `${p}%`; document.getElementById('progress-bar').style.width = `${p}%`;
            lucide.createIcons();
        }

        function createCard(t, od) {
            const d = document.createElement('div'); const act = t.status === 'doing'; const exp = expandedTasks.has(t.id);
            const catObj = categories.find(c => c.name === t.category); const catColor = catObj ? catObj.color : '#64748b';
            
            // Recurrence Icon
            const recurIcon = t.repeat && t.repeat !== 'none' ? `<span class="text-[10px] bg-slate-100 dark:bg-slate-700 text-slate-500 px-1.5 rounded ml-1" title="Repete: ${t.repeat}">üîÑ</span>` : '';

            d.className = `glass-card p-0 rounded-dynamic cursor-grab active:cursor-grabbing relative overflow-hidden group animate-slide-up mb-4 border border-white/40 dark:border-white/5 shadow-sm hover:shadow-md transition-all ${od ? 'task-overdue' : ''} ${act ? 'task-active' : ''}`;
            d.draggable = true;
            d.ondragstart = (e) => { e.dataTransfer.setData("text", t.id); e.target.classList.add('dragging'); };
            d.ondragend = (e) => { e.target.classList.remove('dragging'); };
            const pc = { low: 'bg-emerald-500', medium: 'bg-amber-500', high: 'bg-rose-500' };
            const done = t.subtasks ? t.subtasks.filter(s => s.completed).length : 0; const total = t.subtasks ? t.subtasks.length : 0; const prog = total === 0 ? 0 : Math.round((done/total)*100);
            let dh = ''; if(t.dueDate) { const date = new Date(t.dueDate); date.setMinutes(date.getMinutes() + date.getTimezoneOffset()); const s = date.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'}); dh = `<div class="flex items-center gap-1.5 text-[11px] font-medium mt-2 w-fit ${od ? 'text-rose-500' : 'text-slate-400 dark:text-slate-500'}"><i data-lucide="${od ? 'alert-circle' : 'calendar'}" class="w-3.5 h-3.5"></i> <span>${od ? 'Atrasado: ' : ''}${s}</span></div>`; }
            let acts = act ? `
                <div class="mt-5 pt-4 border-t border-slate-100 dark:border-slate-800 flex gap-2">
                    <button ontouchstart="event.stopPropagation()" onmousedown="event.stopPropagation()" onclick="openPomodoro('${t.id}')" class="flex-1 bg-brand-600 hover:bg-brand-500 text-white py-2 rounded-lg text-xs font-bold uppercase tracking-wide shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95"><i data-lucide="play" class="w-3 h-3 fill-current"></i> Focar</button>
                    <button ontouchstart="event.stopPropagation()" onmousedown="event.stopPropagation()" onclick="completeTask(event, '${t.id}')" class="bg-emerald-100 hover:bg-emerald-200 text-emerald-600 dark:bg-emerald-500/20 dark:hover:bg-emerald-500/30 dark:text-emerald-400 w-9 h-9 flex items-center justify-center rounded-lg transition-colors"><i data-lucide="check" class="w-4 h-4"></i></button>
                    <button ontouchstart="event.stopPropagation()" onmousedown="event.stopPropagation()" onclick="requestDelete(event, '${t.id}')" class="bg-slate-100 hover:bg-rose-100 text-slate-400 hover:text-rose-500 dark:bg-slate-800 dark:hover:bg-rose-900/30 w-9 h-9 flex items-center justify-center rounded-lg transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>` : `
                <div class="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button ontouchstart="event.stopPropagation()" onmousedown="event.stopPropagation()" onclick="editTask('${t.id}')" class="p-1.5 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-md text-slate-400 transition-colors"><i data-lucide="edit-2" class="w-3.5 h-3.5"></i></button>
                    <button ontouchstart="event.stopPropagation()" onmousedown="event.stopPropagation()" onclick="requestDelete(event, '${t.id}')" class="p-1.5 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-md text-slate-400 hover:text-rose-500 transition-colors"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                </div>`;
            d.innerHTML = `
                <div class="absolute left-0 top-0 bottom-0 w-1 ${pc[t.priority]}"></div>
                <div class="pl-5 pr-4 py-4" onclick="toggleSubtaskList(event, '${t.id}')">
                    <div class="flex justify-between items-start"><span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-white dark:bg-slate-800 border text-slate-600 dark:text-slate-300" style="border-color: ${catColor}; box-shadow: 0 0 5px ${catColor}20;">${t.category}</span>${!act ? acts : ''}</div>
                    <h3 class="font-semibold text-slate-800 dark:text-slate-100 text-[15px] mt-2.5 leading-snug pr-6 flex items-start gap-1">${t.title} ${recurIcon}</h3>${dh}
                    ${total > 0 ? `<div class="mt-4" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()"><div class="flex items-center justify-between mb-1.5"><span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">${prog}% Conclu√≠do</span><span class="text-[10px] text-slate-400 font-mono bg-slate-100 dark:bg-slate-800 px-1.5 rounded">${done}/${total}</span></div><div class="w-full h-1.5 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden mb-3"><div class="h-full bg-brand-500 transition-all duration-700 ease-out" style="width: ${prog}%"></div></div><button onclick="toggleSubtaskList(event, '${t.id}')" class="w-full group/btn flex items-center justify-center gap-1.5 text-xs font-medium text-slate-500 dark:text-slate-400 hover:text-brand-600 dark:hover:text-brand-400 py-1.5 rounded-lg border border-transparent hover:border-slate-200 dark:hover:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-all"><span>${exp ? 'Ocultar Checklist' : 'Ver Checklist'}</span><i data-lucide="chevron-down" class="w-3.5 h-3.5 transition-transform duration-300 ${exp ? 'rotate-180' : ''}"></i></button><div class="${exp ? 'block' : 'hidden'} mt-2 space-y-1 animate-slide-in">${t.subtasks.map((st, i) => `<div class="group/item flex items-start gap-3 p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/40 transition-colors cursor-pointer select-none" onclick="toggleSubtaskCheck('${t.id}', ${i})"><div class="relative flex items-center justify-center mt-0.5 shrink-0"><input type="checkbox" ${st.completed ? 'checked' : ''} class="peer appearance-none w-4 h-4 border-2 border-slate-300 dark:border-slate-600 rounded checked:bg-brand-500 checked:border-brand-500 transition-all cursor-pointer pointer-events-none"><i data-lucide="check" class="absolute w-2.5 h-2.5 text-white opacity-0 peer-checked:opacity-100 pointer-events-none transition-opacity duration-200"></i></div><span class="text-xs ${st.completed ? 'line-through text-slate-400 decoration-slate-300' : 'text-slate-700 dark:text-slate-200'} transition-colors leading-relaxed">${st.title}</span></div>`).join('')}</div></div>` : ''}${act ? acts : ''}</div>`;
            return d;
        }

        function toggleSubtaskList(e, id) { e.stopPropagation(); expandedTasks.has(id) ? expandedTasks.delete(id) : expandedTasks.add(id); renderBoard(); }
        function toggleSubtaskCheck(id, idx) { const t = tasks.find(x => x.id === id); if(t && t.subtasks) { t.subtasks[idx].completed = !t.subtasks[idx].completed; saveTasks(); } }
        
        function completeTask(e, id) { 
            if(e) e.stopPropagation(); 
            const t = tasks.find(t => t.id === id); 
            if(t) { 
                // Log Completion
                completionLog.push({ date: new Date().toISOString().split('T')[0], taskId: t.id });
                localStorage.setItem('flowtask_log', JSON.stringify(completionLog));

                // Recurrence Logic
                if (t.repeat && t.repeat !== 'none') {
                    // Reset Subtasks
                    if(t.subtasks) t.subtasks.forEach(s => s.completed = false);
                    
                    // Calculate next date
                    const nextDate = new Date();
                    if (t.repeat === 'daily') nextDate.setDate(nextDate.getDate() + 1);
                    if (t.repeat === 'weekly') nextDate.setDate(nextDate.getDate() + 7);
                    
                    t.dueDate = nextDate.toISOString().split('T')[0];
                    t.status = 'todo'; // Returns to todo
                    alert(`Tarefa recorrente reagendada para ${t.dueDate.split('-').reverse().join('/')}`);
                } else {
                    t.status = 'done'; 
                    if(t.subtasks) t.subtasks.forEach(s => s.completed = true); 
                }
                
                saveTasks(); 
                fireConfetti(); 
            } 
        }

        function openModal(id = null) {
            const m = document.getElementById('task-modal'); m.classList.remove('hidden'); currentEditingId = id; tempSubtasks = [];
            const form = document.getElementById('task-form');
            renderTaskModalCategories(); 
            if(id) {
                const t = tasks.find(x => x.id === id);
                document.getElementById('modal-title').innerText = "Editar Tarefa";
                document.getElementById('task-title').value = t.title; document.getElementById('task-category').value = t.category;
                document.getElementById('task-due-date').value = t.dueDate || '';
                document.getElementById('task-repeat').value = t.repeat || 'none';
                document.getElementsByName('priority').forEach(r => r.checked = r.value === t.priority);
                tempSubtasks = t.subtasks ? [...t.subtasks] : [];
            } else {
                document.getElementById('modal-title').innerText = "Nova Tarefa"; form.reset();
                document.getElementsByName('priority')[1].checked = true;
                document.getElementById('task-repeat').value = 'none';
            }
            renderSubtasks(); document.getElementById('task-title').focus();
        }
        function closeModal() { document.getElementById('task-modal').classList.add('hidden'); }
        function editTask(id) { openModal(id); }
        function addSubtaskToForm() { const v = document.getElementById('new-subtask-input').value.trim(); if(v) { tempSubtasks.push({title:v, completed:false}); document.getElementById('new-subtask-input').value=''; renderSubtasks(); } }
        function removeSubtask(idx) { tempSubtasks.splice(idx,1); renderSubtasks(); }
        function renderSubtasks() { document.getElementById('subtask-list-form').innerHTML = tempSubtasks.map((s,i) => `<li class="flex justify-between items-center text-sm bg-slate-100 dark:bg-slate-800 px-3 py-2 rounded mb-1"><span class="dark:text-slate-300">${s.title}</span><button type="button" onclick="removeSubtask(${i})" class="text-rose-500"><i data-lucide="x" class="w-4 h-4"></i></button></li>`).join(''); lucide.createIcons(); }
        
        function saveTask(e) { 
            e.preventDefault(); 
            const data = { 
                title: document.getElementById('task-title').value, 
                category: document.getElementById('task-category').value, 
                dueDate: document.getElementById('task-due-date').value, 
                priority: document.querySelector('input[name="priority"]:checked').value, 
                subtasks: tempSubtasks,
                repeat: document.getElementById('task-repeat').value
            }; 
            if(currentEditingId) { 
                const idx = tasks.findIndex(t => t.id === currentEditingId); 
                tasks[idx] = { ...tasks[idx], ...data }; 
            } else { 
                tasks.push({ id: generateId(), status: 'todo', createdAt: new Date().toISOString(), ...data }); 
            } 
            saveTasks(); 
            closeModal(); 
        }
        function allowDrop(e) { e.preventDefault(); }
        function drop(e, status) { e.preventDefault(); const id = e.dataTransfer.getData("text"); const t = tasks.find(x => x.id === id); if(t && t.status !== status) { t.status = status; if(status === 'done') { completeTask(null, id); } else { saveTasks(); } } }

        function openPomodoro(id) { const t = tasks.find(x => x.id === id); document.getElementById('pomo-task-title').innerText = t.title; document.getElementById('btn-motivate').classList.remove('hidden'); document.getElementById('motivation-text').classList.add('hidden'); document.getElementById('pomodoro-modal').classList.remove('hidden'); setTimerDuration(25); isEditingTimer = false; }
        function closePomodoro() { document.getElementById('pomodoro-modal').classList.add('hidden'); stopTimer(); isEditingTimer = false; if(brownNoiseNode) toggleBrownNoise(); }
        function setTimerDuration(m) { stopTimer(); initialTime = m * 60; timeLeft = initialTime; document.querySelectorAll('.timer-btn').forEach(b => { if(parseInt(b.dataset.time)===m) { b.classList.add('bg-brand-600','text-white'); b.classList.remove('text-slate-300'); } else { b.classList.remove('bg-brand-600','text-white'); b.classList.add('text-slate-300'); } }); updateTimerDisplay(); }
        function startTimerEdit() { if(isTimerRunning) stopTimer(); isEditingTimer = true; timerDigits = []; updateTimerEditUI(); const inp = document.getElementById('hidden-timer-input'); inp.value = ''; inp.focus(); document.getElementById('timer-status').innerText = "Digite..."; }
        function handleTimerInput(e) { if(!isEditingTimer) return; const c = e.target.value.slice(-1); if(/[0-9]/.test(c)) { if(timerDigits.length < 4) timerDigits.push(c); } e.target.value = ''; updateTimerEditUI(); if(timerDigits.length === 4) setTimeout(() => document.getElementById('hidden-timer-input').blur(), 300); }
        function finishTimerEdit() { if(!isEditingTimer) return; const m = parseInt((timerDigits[0]||'0') + (timerDigits[1]||'0')); const s = parseInt((timerDigits[2]||'0') + (timerDigits[3]||'0')); const t = m*60 + s; if(t > 0) { initialTime = t; timeLeft = t; } else { initialTime = 25*60; timeLeft = initialTime; } isEditingTimer = false; updateTimerDisplay(); document.getElementById('timer-status').innerText = "Personalizado"; }
        function updateTimerEditUI() { const d = timerDigits; let html = ''; for(let i=0; i<4; i++) { if(i===2) html += '<span class="mx-1 text-white/50 pb-2">:</span>'; html += `<span class="timer-slot ${d.length===i ? 'active' : ''} ${!d[i] ? 'empty' : ''}">${d[i]||'0'}</span>`; } document.getElementById('timer-display').innerHTML = html; }
        function toggleTimer() { isTimerRunning ? stopTimer() : startTimer(); }
        
        function startTimer() { isTimerRunning = true; document.getElementById('timer-status').innerText = "Foco total!"; document.getElementById('btn-toggle-timer').innerHTML = `<i data-lucide="pause" class="w-8 h-8 fill-current"></i>`; lucide.createIcons(); if (document.documentElement.requestFullscreen) { document.documentElement.requestFullscreen().catch(e=>{}); } timerInterval = setInterval(() => { if(timeLeft > 0) { timeLeft--; updateTimerDisplay(); } else { stopTimer(); playBeep(); fireConfetti(); if(navigator.vibrate) navigator.vibrate([100, 50, 100]); if(Notification.permission === "granted") new Notification("Pomodoro Conclu√≠do!", {body: "Hora de descansar."}); pomoCount++; localStorage.setItem('pomo_count', pomoCount); document.getElementById('timer-status').innerText = "Ciclo Conclu√≠do!"; document.getElementById('timer-display').classList.add('animate-pulse'); } }, 1000); }
        function stopTimer() { isTimerRunning = false; clearInterval(timerInterval); document.getElementById('timer-status').innerText = "Pausado"; document.getElementById('btn-toggle-timer').innerHTML = `<i data-lucide="play" class="w-8 h-8 fill-current"></i>`; lucide.createIcons(); document.getElementById('timer-display').classList.remove('animate-pulse'); if (document.exitFullscreen && document.fullscreenElement) { document.exitFullscreen().catch(e=>{}); } }
        function resetTimer() { stopTimer(); timeLeft = initialTime; updateTimerDisplay(); }
        function updateTimerDisplay() { if(isEditingTimer) return; const m = Math.floor(timeLeft/60).toString().padStart(2,'0'); const s = (timeLeft%60).toString().padStart(2,'0'); const str = m + ":" + s; let html = ''; for(let char of str) html += `<span class="digit-wrapper"><span class="digit">${char}</span></span>`; document.getElementById('timer-display').innerHTML = html; const circle = document.getElementById('timer-circle'); const dash = circle.r.baseVal.value * 2 * Math.PI; const offset = dash - (timeLeft/initialTime) * dash; circle.style.strokeDashoffset = offset; }
        function fireConfetti() { const c = document.getElementById('confetti'); const ctx = c.getContext('2d'); c.width = window.innerWidth; c.height = window.innerHeight; const p = Array.from({length:100}, () => ({ x: Math.random()*c.width, y: Math.random()*c.height - c.height, color: `hsl(${Math.random()*360},70%,50%)`, size: Math.random()*10+5, speed: Math.random()*5+2 })); function step() { ctx.clearRect(0,0,c.width,c.height); let a = false; p.forEach(i => { i.y += i.speed; i.x += Math.sin(i.y/50); if(i.y < c.height) a = true; ctx.fillStyle = i.color; ctx.fillRect(i.x, i.y, i.size, i.size); }); if(a) requestAnimationFrame(step); } step(); }
    </script>
</body>
</html>
