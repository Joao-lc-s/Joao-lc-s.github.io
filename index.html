<!DOCTYPE html>
<html lang="pt-BR" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA & Mobile Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FlowTask">
    <meta name="theme-color" content="#6366f1">
    
    <!-- Ícones -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%236366f1' rx='40'/%3E%3Cpath d='M45 90L90 112.5L135 90L90 67.5L45 90Z' fill='white' stroke='white' stroke-width='4'/%3E%3Cpath d='M45 110L90 132.5L135 110' stroke='white' stroke-width='8' fill='none'/%3E%3Cpath d='M45 130L90 152.5L135 130' stroke='white' stroke-width='8' fill='none'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%236366f1' rx='40'/%3E%3Cpath d='M45 90L90 112.5L135 90L90 67.5L45 90Z' fill='white' stroke='white' stroke-width='4'/%3E%3Cpath d='M45 110L90 132.5L135 110' stroke='white' stroke-width='8' fill='none'/%3E%3Cpath d='M45 130L90 152.5L135 130' stroke='white' stroke-width='8' fill='none'/%3E%3C/svg%3E">
    
    <!-- Manifesto Dinâmico -->
    <link rel="manifest" href='data:application/manifest+json;base64,eyJuYW1lIjoiRmxvd1Rhc2sgUHJvIiwic2hvcnRfbmFtZSI6IkZsb3dUYXNrIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiM2MzY2ZjEiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sOy4uLiIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ=='>

    <title>FlowTask Pro | Cloud Sync</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        brand: { 50: 'rgb(var(--c-50))', 100: 'rgb(var(--c-100))', 500: 'rgb(var(--c-500))', 600: 'rgb(var(--c-600))', 700: 'rgb(var(--c-700))' },
                        dark: { 800: '#1e293b', 900: '#0f172a' }
                    },
                    animation: { 'slide-up': 'slideUp 0.3s ease-out', 'slide-in': 'slideIn 0.4s ease-out' },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        slideIn: { '0%': { transform: 'translateX(-20px)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --c-50: 238 242 255; --c-100: 224 231 255; --c-500: 99 102 241; --c-600: 79 70 229; --c-700: 67 56 202;
            --bg-from: #6366f1; --bg-to: #a855f7;
            --ui-radius: 0.75rem; --ui-font: 16px;
        }
        body { transition: background-color 0.3s; -webkit-tap-highlight-color: transparent; font-size: var(--ui-font); overscroll-behavior-y: none; }
        .rounded-dynamic { border-radius: var(--ui-radius) !important; }
        .glass { background: rgba(255,255,255,0.7); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.5); }
        .dark .glass { background: rgba(30,41,59,0.6); border: 1px solid rgba(255,255,255,0.05); }
        .glass-card { background: rgba(255,255,255,0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.4); border-radius: var(--ui-radius); transition: all 0.2s; }
        .dark .glass-card { background: rgba(30,41,59,0.8); border: 1px solid rgba(255,255,255,0.08); }
        .glass-card:active { transform: scale(0.98); }
        .form-input-fixed { height: 42px !important; min-height: 42px; padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .appearance-none { -webkit-appearance: none; appearance: none; }
        .dark input[type="date"] { color-scheme: dark; }
        .task-overdue { border-left: 4px solid #f43f5e !important; }
        .task-active { border: 2px solid transparent !important; }
        button, input, select { pointer-events: auto; z-index: 20; }
        .dragging { opacity: 0.5; transform: scale(0.95); }
        #settings-sidebar { transition: transform 0.3s cubic-bezier(0.4,0,0.2,1); }
        #settings-sidebar.closed { transform: translateX(100%); }
        .blob-1 { background-color: var(--bg-from); opacity: 0.3; } .blob-2 { background-color: var(--bg-to); opacity: 0.3; }
        .snap-x-mandatory { scroll-snap-type: x mandatory; } .snap-center { scroll-snap-align: center; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 min-h-screen selection:bg-brand-500 selection:text-white overflow-hidden pt-[env(safe-area-inset-top)]">

    <!-- OFFLINE INDICATOR -->
    <div id="offline-indicator" class="fixed top-0 left-0 w-full bg-rose-500 text-white text-xs font-bold text-center py-1 z-[100] hidden">
        Você está offline. As alterações estão sendo salvas localmente.
    </div>

    <div class="fixed inset-0 pointer-events-none z-0">
        <div class="blob-1 absolute top-0 left-0 w-[800px] h-[800px] rounded-full blur-[120px] mix-blend-multiply dark:mix-blend-screen animate-pulse"></div>
        <div class="blob-2 absolute bottom-0 right-0 w-[600px] h-[600px] rounded-full blur-[120px] mix-blend-multiply dark:mix-blend-screen animate-pulse" style="animation-delay: 2s;"></div>
    </div>

    <div class="relative z-10 flex flex-col h-screen max-w-7xl mx-auto p-4 md:p-6">
        
        <header class="flex justify-between items-center mb-4 shrink-0 pt-2 gap-3">
            <div class="flex items-center gap-3 overflow-hidden">
                <div class="p-2 bg-gradient-to-tr from-brand-600 to-purple-600 rounded-xl shadow-lg shrink-0">
                    <i data-lucide="layers" class="text-white w-5 h-5"></i>
                </div>
                <div class="min-w-0">
                    <h1 class="text-xl font-bold tracking-tight truncate">FlowTask <span class="text-brand-500">Cloud</span></h1>
                    <p id="date-display" class="text-xs text-slate-500 dark:text-slate-400 capitalize truncate"></p>
                </div>
            </div>
            
            <div class="flex items-center gap-2 shrink-0">
                <button onclick="toggleSettings()" class="p-2.5 rounded-dynamic bg-white/50 dark:bg-slate-800/50 hover:bg-white transition-all active:scale-95"><i data-lucide="settings" class="w-5 h-5 text-slate-600 dark:text-slate-300"></i></button>
                <button id="theme-toggle" class="p-2.5 rounded-dynamic bg-white/50 dark:bg-slate-800/50 hover:bg-white transition-all active:scale-95">
                    <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
                    <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                </button>
                <button onclick="openModal()" class="flex items-center gap-2 px-4 py-2.5 bg-brand-600 hover:bg-brand-500 text-white rounded-dynamic font-medium shadow-lg transition-transform active:scale-95"><i data-lucide="plus" class="w-5 h-5"></i><span class="hidden md:inline">Nova</span></button>
            </div>
        </header>

        <!-- STATS -->
        <div class="glass rounded-dynamic p-4 mb-4 shrink-0 animate-slide-up">
            <div class="flex justify-between items-end mb-2"><span class="text-xs font-bold text-slate-500 uppercase">Progresso</span><span id="progress-text" class="text-lg font-bold text-brand-600">0%</span></div>
            <div class="w-full h-2 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden"><div id="progress-bar" class="h-full bg-brand-500 rounded-full transition-all duration-1000 w-0"></div></div>
        </div>

        <!-- BOARD -->
        <div class="flex-1 overflow-x-auto overflow-y-hidden pb-4 -mx-4 px-4 md:mx-0 md:px-0 snap-x-mandatory custom-scrollbar">
            <div class="flex gap-4 h-full w-max md:w-full md:min-w-0 pr-10 md:pr-0">
                <!-- TODO -->
                <div class="flex flex-col w-[85vw] md:w-auto md:flex-1 min-w-[300px] bg-slate-100/50 dark:bg-slate-900/30 rounded-dynamic border border-white/50 dark:border-white/5 backdrop-blur-sm snap-center">
                    <div class="p-4 pb-2 font-bold text-slate-600 dark:text-slate-300 flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-slate-400"></div> A Fazer</div>
                    <div id="col-todo" class="p-3 flex-1 overflow-y-auto space-y-3 custom-scrollbar" ondrop="drop(event, 'todo')" ondragover="allowDrop(event)"></div>
                </div>
                <!-- DOING -->
                <div class="flex flex-col w-[85vw] md:w-auto md:flex-1 min-w-[300px] bg-slate-100/50 dark:bg-slate-900/30 rounded-dynamic border border-white/50 dark:border-white/5 backdrop-blur-sm snap-center">
                    <div class="p-4 pb-2 font-bold text-brand-600 dark:text-brand-500 flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-brand-500 animate-pulse"></div> Em Andamento</div>
                    <div id="col-doing" class="p-3 flex-1 overflow-y-auto space-y-3 custom-scrollbar" ondrop="drop(event, 'doing')" ondragover="allowDrop(event)"></div>
                </div>
                <!-- DONE -->
                <div class="flex flex-col w-[85vw] md:w-auto md:flex-1 min-w-[300px] bg-slate-100/50 dark:bg-slate-900/30 rounded-dynamic border border-white/50 dark:border-white/5 backdrop-blur-sm snap-center">
                    <div class="p-4 pb-2 font-bold text-emerald-600 dark:text-emerald-400 flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-emerald-500"></div> Concluído</div>
                    <div id="col-done" class="p-3 flex-1 overflow-y-auto space-y-3 custom-scrollbar" ondrop="drop(event, 'done')" ondragover="allowDrop(event)"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS SIDEBAR -->
    <div id="settings-sidebar" class="fixed top-0 right-0 h-full w-80 bg-white dark:bg-slate-900 shadow-2xl z-[80] closed p-6 pt-20 flex flex-col overflow-y-auto border-l border-slate-200 dark:border-slate-800">
        <button onclick="toggleSettings()" class="absolute top-6 right-6 p-2 bg-slate-100 dark:bg-slate-800 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
        
        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Categorias</h3>
        <div id="categories-list" class="space-y-3 mb-6"></div>
        <button onclick="addCategory()" class="w-full py-2 border border-dashed border-slate-300 dark:border-slate-700 rounded text-slate-500 hover:text-brand-500 text-sm mb-6">+ Adicionar Categoria</button>
        
        <hr class="border-slate-200 dark:border-slate-800 mb-6">
        
        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Aparência</h3>
        <div class="space-y-4 mb-6">
            <div>
                <label class="text-sm text-slate-700 dark:text-slate-300 block mb-2">Cor Principal</label>
                <div class="flex gap-2">
                    <input type="color" id="brand-picker" class="w-10 h-10 rounded cursor-pointer border-0 p-0" onchange="setBrandColor(this.value)">
                    <input type="text" id="brand-hex-input" class="flex-1 bg-slate-100 dark:bg-slate-800 border-none rounded px-3 text-sm font-mono" placeholder="#HEX" onchange="setBrandColor(this.value)">
                </div>
            </div>
        </div>

        <!-- SEARCH BAR (Mobile) -->
         <div class="sm:hidden mb-6">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Busca</h3>
            <input type="text" id="mobile-search-input" onkeyup="renderBoard()" placeholder="Buscar tarefas..." class="w-full bg-slate-100 dark:bg-slate-800 border-none rounded px-3 py-2 text-sm">
        </div>

        <div class="mt-auto pt-6 text-center">
             <span id="sync-status" class="text-xs font-bold text-amber-500 flex items-center justify-center gap-1"><i data-lucide="cloud" class="w-3 h-3"></i> Conectando...</span>
        </div>
    </div>
    <div id="settings-overlay" onclick="toggleSettings()" class="fixed inset-0 bg-black/20 backdrop-blur-sm z-[75] hidden transition-opacity"></div>

    <!-- TASK MODAL -->
    <div id="task-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="glass bg-white dark:bg-slate-900 w-full max-w-lg rounded-dynamic shadow-2xl p-6 relative animate-slide-up max-h-[90vh] overflow-y-auto">
            <h2 id="modal-title" class="text-xl font-bold mb-6">Nova Tarefa</h2>
            <form id="task-form" onsubmit="handleTaskSubmit(event)">
                <div class="space-y-4">
                    <input type="text" id="task-title" required class="w-full form-input-fixed bg-slate-100 dark:bg-slate-800 border-none rounded-lg px-4 outline-none" placeholder="Título da tarefa">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="date" id="task-due-date" class="form-input-fixed appearance-none bg-slate-100 dark:bg-slate-800 border-none rounded-lg px-3 outline-none w-full">
                        <select id="task-category" class="form-input-fixed bg-slate-100 dark:bg-slate-800 border-none rounded-lg px-3 outline-none w-full"></select>
                    </div>
                    <div class="flex gap-2">
                        <label class="flex-1 cursor-pointer"><input type="radio" name="priority" value="low" class="peer sr-only"><div class="py-2 text-center rounded-lg bg-slate-100 dark:bg-slate-800 peer-checked:bg-emerald-500 peer-checked:text-white text-sm">Baixa</div></label>
                        <label class="flex-1 cursor-pointer"><input type="radio" name="priority" value="medium" class="peer sr-only" checked><div class="py-2 text-center rounded-lg bg-slate-100 dark:bg-slate-800 peer-checked:bg-amber-500 peer-checked:text-white text-sm">Média</div></label>
                        <label class="flex-1 cursor-pointer"><input type="radio" name="priority" value="high" class="peer sr-only"><div class="py-2 text-center rounded-lg bg-slate-100 dark:bg-slate-800 peer-checked:bg-rose-500 peer-checked:text-white text-sm">Alta</div></label>
                    </div>
                    <!-- Checklist -->
                    <div>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="subtask-input" class="flex-1 bg-slate-100 dark:bg-slate-800 rounded-lg px-3 py-2 text-sm outline-none" placeholder="Nova etapa...">
                            <button type="button" onclick="addSubtask()" class="bg-brand-600 text-white p-2 rounded-lg"><i data-lucide="plus" class="w-4 h-4"></i></button>
                        </div>
                        <ul id="subtask-list" class="space-y-1"></ul>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-sm text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-brand-600 text-white rounded-lg font-bold shadow-lg">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- DELETE MODAL -->
    <div id="delete-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeDeleteModal()"></div>
        <div class="glass bg-white dark:bg-slate-900 w-full max-w-sm rounded-dynamic shadow-2xl p-6 relative animate-pop text-center">
            <div class="w-12 h-12 bg-rose-100 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="trash-2" class="w-6 h-6"></i></div>
            <h3 class="text-lg font-bold mb-2">Excluir Tarefa?</h3>
            <p class="text-sm text-slate-500 mb-6">Não será possível desfazer.</p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeDeleteModal()" class="flex-1 py-2 rounded-lg bg-slate-100 dark:bg-slate-800">Cancelar</button>
                <button onclick="confirmDelete()" class="flex-1 py-2 rounded-lg bg-rose-500 text-white shadow-lg">Excluir</button>
            </div>
        </div>
    </div>

    <!-- POMODORO MODAL -->
    <div id="pomodoro-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-md" onclick="closePomodoro()"></div>
        <div class="relative z-10 flex flex-col items-center w-full max-w-md">
            <div class="mb-6 text-center animate-slide-up w-full">
                <span class="text-brand-400 font-bold tracking-widest uppercase text-xs border border-brand-500/30 px-3 py-1 rounded-full bg-brand-500/10">Modo Foco</span>
                <h2 id="pomo-task-title" class="text-2xl md:text-3xl font-bold mt-4 mx-auto truncate px-4 w-full text-white"></h2>
            </div>
            
            <!-- Timer Circle -->
            <div class="relative w-72 h-72 shrink-0 flex items-center justify-center group/timer mb-8">
                <svg class="w-full h-full" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="none" stroke="#1e293b" stroke-width="4" /><circle id="timer-circle" class="progress-ring__circle" cx="50" cy="50" r="45" fill="none" stroke="rgb(var(--color-brand-500))" stroke-width="4" stroke-linecap="round" stroke-dasharray="283" stroke-dashoffset="0" /></svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center z-10">
                    <div id="timer-display" class="text-6xl font-bold tracking-tighter font-mono text-white">25:00</div>
                    <span id="timer-status" class="text-slate-400 mt-4 text-sm font-medium">Pausado</span>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex gap-4">
                <button onclick="toggleTimer()" id="btn-toggle-timer" class="w-16 h-16 rounded-full bg-brand-500 text-white flex items-center justify-center shadow-lg hover:scale-110 transition-transform"><i data-lucide="play" class="w-8 h-8 fill-current"></i></button>
                <button onclick="resetTimer()" class="w-16 h-16 rounded-full bg-slate-800 text-white flex items-center justify-center border border-white/10 hover:bg-slate-700 transition-colors"><i data-lucide="rotate-ccw" class="w-6 h-6"></i></button>
            </div>
            <button onclick="closePomodoro()" class="mt-8 text-slate-400 hover:text-white text-sm">Fechar</button>
        </div>
    </div>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCe2nWYJ1LIieu3mBu_kWm6xNox6KXiE14",
            authDomain: "flowtask-1a1e5.firebaseapp.com",
            projectId: "flowtask-1a1e5",
            storageBucket: "flowtask-1a1e5.firebasestorage.app",
            messagingSenderId: "99007666696",
            appId: "1:99007666696:web:12d87a292cf75af50c4fbd",
            measurementId: "G-1VN5GCTF0X"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        
        let currentUser = null;

        function updateSyncStatus(html) {
            const el = document.getElementById('sync-status');
            if(el) {
                el.innerHTML = html;
                if(window.lucide) window.lucide.createIcons();
            }
        }

        async function performSignIn() {
             try {
                await signInAnonymously(auth);
            } catch (e) {
                console.warn("Aviso Firebase:", e.code);
                if (e.code === 'auth/configuration-not-found' || e.code === 'auth/operation-not-allowed' || e.code === 'auth/admin-restricted-operation') {
                     updateSyncStatus('<span class="text-slate-400 flex items-center gap-1" title="Ative o Login Anônimo no Firebase para sincronizar"><i data-lucide="hard-drive" class="w-3 h-3"></i> Modo Local</span>');
                } else {
                     updateSyncStatus('<span class="text-rose-500 flex items-center gap-1"><i data-lucide="wifi-off" class="w-3 h-3"></i> Offline</span>');
                }
            }
        }

        async function initAuth() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    setupListeners();
                } else {
                    performSignIn();
                }
            });
        }

        function setupListeners() {
            if (!currentUser) return;

            const tasksRef = collection(db, 'users', currentUser.uid, 'tasks');
            onSnapshot(tasksRef, (snapshot) => {
                const newTasks = [];
                snapshot.forEach(doc => newTasks.push({ id: doc.id, ...doc.data() }));
                window.tasks = newTasks; 
                localStorage.setItem('flowtask_tasks', JSON.stringify(newTasks)); 
                if (typeof window.renderBoard === 'function') window.renderBoard(); 
                updateSyncStatus('<span class="text-emerald-500 flex items-center gap-1"><i data-lucide="cloud" class="w-3 h-3"></i> Online</span>');
                lucide.createIcons();
            }, (err) => {
                console.warn("Firestore inacessível, mantendo local.", err.code);
            });

            const catRef = doc(db, 'users', currentUser.uid, 'settings', 'categories');
            onSnapshot(catRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.categories = docSnap.data().list;
                    localStorage.setItem('flowtask_categories', JSON.stringify(window.categories));
                    if (typeof window.renderCategoriesSettings === 'function') window.renderCategoriesSettings();
                    if (typeof window.renderBoard === 'function') window.renderBoard();
                } else {
                    if (!window.categories || window.categories.length === 0) {
                        window.categories = [
                            { id: 'cat_1', name: 'Trabalho', color: '#6366f1' },
                            { id: 'c2', name: 'Pessoal', color: '#ec4899' },
                            { id: 'c3', name: 'Estudo', color: '#f59e0b' },
                            { id: 'c4', name: 'Saúde', color: '#10b981' }
                        ];
                    }
                    setDoc(catRef, { list: window.categories }).catch(e => console.log("Modo leitura apenas"));
                }
            });
        }

        window.saveTaskToDB = async (data, id) => {
            if (!currentUser) return;
            try {
                if(id) await updateDoc(doc(db, 'users', currentUser.uid, 'tasks', id), data);
                else await addDoc(collection(db, 'users', currentUser.uid, 'tasks'), {...data, createdAt: new Date().toISOString()});
            } catch(e) { console.log("Operação local apenas"); }
        };
        window.deleteTaskFromDB = async (id) => {
            if (!currentUser) return;
            try { await deleteDoc(doc(db, 'users', currentUser.uid, 'tasks', id)); } catch(e) {}
        };
        window.saveCategoriesToDB = async (cats) => {
            if (!currentUser) return;
            try { await setDoc(doc(db, 'users', currentUser.uid, 'settings', 'categories'), { list: cats }); } catch(e) {}
        };
        window.updateTaskStatus = async (id, status) => {
             if (!currentUser) return;
             try { await updateDoc(doc(db, 'users', currentUser.uid, 'tasks', id), {status}); } catch(e) {}
        };
        window.updateTaskSubtasks = async (id, subtasks) => {
             if (!currentUser) return;
             try { await updateDoc(doc(db, 'users', currentUser.uid, 'tasks', id), {subtasks}); } catch(e) {}
        };
        window.completeTaskDB = async (id, subtasks) => {
             if (!currentUser) return;
             try { await updateDoc(doc(db, 'users', currentUser.uid, 'tasks', id), {status: 'done', subtasks}); } catch(e) {}
        };

        initAuth();
    </script>

    <!-- UI LOGIC (Non-Firebase) -->
    <script>
        // GLOBALS
        window.tasks = JSON.parse(localStorage.getItem('flowtask_tasks') || '[]');
        window.categories = JSON.parse(localStorage.getItem('flowtask_categories') || '[]');
        
        // Initial Category Fallback
        if (window.categories.length === 0) {
            window.categories = [
                { id: 'cat_1', name: 'Trabalho', color: '#6366f1' },
                { id: 'cat_2', name: 'Pessoal', color: '#ec4899' },
                { id: 'cat_3', name: 'Estudo', color: '#f59e0b' },
                { id: 'cat_4', name: 'Saúde', color: '#10b981' }
            ];
            localStorage.setItem('flowtask_categories', JSON.stringify(window.categories));
        }

        window.tempSubtasks = [];
        window.currentEditingId = null;
        window.taskToDeleteId = null;
        let timerInterval = null, timeLeft = 25*60, isTimerRunning = false, isEditingTimer = false, timerDigits = [], expandedTasks = new Set(), soundEnabled = true, pomoCount = 0;
        let pwaPrompt;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep() {
            if(!soundEnabled) return;
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination); o.type = 'sine'; o.frequency.value = 880;
            g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5);
            o.start(); o.stop(audioCtx.currentTime + 0.5);
        }

        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); pwaPrompt = e; document.getElementById('pwa-install-area').classList.remove('hidden'); });
        async function installPWA() { if (pwaPrompt) { pwaPrompt.prompt(); const { outcome } = await pwaPrompt.userChoice; if (outcome === 'accepted') document.getElementById('pwa-install-area').classList.add('hidden'); pwaPrompt = null; } }
        if ('Notification' in window) Notification.requestPermission();
        window.addEventListener('offline', () => document.getElementById('offline-indicator').classList.remove('hidden'));
        window.addEventListener('online', () => document.getElementById('offline-indicator').classList.add('hidden'));
        document.addEventListener('keydown', (e) => { if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return; if (e.key === 'n' || e.key === 'N') openModal(); if (e.key === 'Escape') { closeModal(); closeDeleteModal(); toggleSettings(); } if (e.key === '/') { e.preventDefault(); document.getElementById('search-input').focus(); } });

        document.addEventListener('DOMContentLoaded', () => {
            renderBoard(); 
            renderCategoriesSettings();
            updateDate();
            lucide.createIcons();
            if(localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
            const h = document.getElementById('hidden-timer-input'); 
            if(h) {
                h.addEventListener('input', handleTimerInput); 
                h.addEventListener('blur', finishTimerEdit);
            }
        });

        // --- FUNCTIONS ---
        function generateId() { return Math.random().toString(36).substr(2, 9); }
        function updateDate() { document.getElementById('date-display').innerText = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' }); }
        function toggleSettings() { document.getElementById('settings-sidebar').classList.toggle('closed'); document.getElementById('settings-overlay').classList.toggle('hidden'); }
        function closeModal() { document.getElementById('task-modal').classList.add('hidden'); }
        function closeDeleteModal() { document.getElementById('delete-modal').classList.add('hidden'); }
        
        function openModal(id = null) {
            window.currentEditingId = id;
            window.tempSubtasks = [];
            const modal = document.getElementById('task-modal');
            const titleEl = document.getElementById('task-title');
            const catSelect = document.getElementById('task-category');
            
            if(!modal || !titleEl || !catSelect) return;

            catSelect.innerHTML = window.categories.length ? 
                window.categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('') : 
                '<option>Padrão</option>';

            if(id) {
                const t = window.tasks.find(x => x.id === id);
                if(t) {
                    document.getElementById('modal-title').innerText = "Editar";
                    titleEl.value = t.title;
                    catSelect.value = t.category;
                    document.getElementById('task-due-date').value = t.dueDate || '';
                    window.tempSubtasks = t.subtasks ? [...t.subtasks] : [];
                    document.querySelectorAll('input[name="priority"]').forEach(r => r.checked = r.value === t.priority);
                }
            } else {
                document.getElementById('modal-title').innerText = "Nova Tarefa";
                document.getElementById('task-form').reset();
                document.querySelector('input[value="medium"]').checked = true;
            }
            renderSubtasks();
            modal.classList.remove('hidden');
            titleEl.focus();
        }

        function renderSubtasks() {
            document.getElementById('subtask-list').innerHTML = window.tempSubtasks.map((s, i) => `
                <li class="flex justify-between items-center text-sm bg-slate-100 dark:bg-slate-800 p-2 rounded">
                    <span>${s.title}</span>
                    <button type="button" onclick="removeSubtask(${i})" class="text-rose-500"><i data-lucide="x" class="w-4 h-4"></i></button>
                </li>
            `).join('');
            lucide.createIcons();
        }
        function addSubtask() {
            const inp = document.getElementById('subtask-input');
            const val = inp.value.trim();
            if(val) { window.tempSubtasks.push({title: val, completed: false}); inp.value=''; renderSubtasks(); }
        }
        function removeSubtask(i) { window.tempSubtasks.splice(i,1); renderSubtasks(); }

        // --- HYBRID SAVE FUNCTION (Optimistic UI) ---
        function handleTaskSubmit(e) {
            e.preventDefault();
            const data = {
                title: document.getElementById('task-title').value,
                category: document.getElementById('task-category').value,
                dueDate: document.getElementById('task-due-date').value,
                priority: document.querySelector('input[name="priority"]:checked').value,
                subtasks: window.tempSubtasks || [],
                status: window.currentEditingId ? (window.tasks.find(t=>t.id===window.currentEditingId)?.status || 'todo') : 'todo'
            };
            
            // 1. Atualiza Localmente (Instantâneo)
            if (window.currentEditingId) {
                const idx = window.tasks.findIndex(t => t.id === window.currentEditingId);
                if (idx !== -1) window.tasks[idx] = { ...window.tasks[idx], ...data };
            } else {
                const newId = generateId(); // ID temporário se offline
                window.tasks.push({ id: newId, createdAt: new Date().toISOString(), ...data });
                // Passa o ID novo para o DB se for criação
                window.currentEditingId = null; // Reset para a função do DB entender que é novo? Não, DB precisa saber.
                // Na verdade, saveTaskToDB lida com ID null como create.
            }
            localStorage.setItem('flowtask_tasks', JSON.stringify(window.tasks));
            renderBoard();
            
            // 2. Envia para Nuvem (Background)
            window.saveTaskToDB(data, window.currentEditingId);
            
            closeModal();
        }

        function requestDelete(e, id) {
            if(e) e.stopPropagation();
            window.taskToDeleteId = id;
            document.getElementById('delete-modal').classList.remove('hidden');
        }
        function confirmDelete() {
            if(window.taskToDeleteId) {
                // 1. Atualiza Local
                window.tasks = window.tasks.filter(t => t.id !== window.taskToDeleteId);
                localStorage.setItem('flowtask_tasks', JSON.stringify(window.tasks));
                renderBoard();

                // 2. Envia para Nuvem
                window.deleteTaskFromDB(window.taskToDeleteId);
                closeDeleteModal();
            }
        }
        function drop(e, newStatus) {
            e.preventDefault();
            const id = e.dataTransfer.getData("text");
            const t = window.tasks.find(x => x.id === id);
            if(t && t.status !== newStatus) {
                // 1. Local
                t.status = newStatus;
                if(newStatus === 'done') {
                    fireConfetti();
                    if(t.subtasks) t.subtasks.forEach(s => s.completed = true);
                }
                localStorage.setItem('flowtask_tasks', JSON.stringify(window.tasks));
                renderBoard();

                // 2. Nuvem
                window.updateTaskStatus(id, newStatus); 
            }
        }
        function allowDrop(e) { e.preventDefault(); }

        function renderCategoriesSettings() {
            const list = document.getElementById('categories-list');
            if(!list) return;
            list.innerHTML = window.categories.map(cat => `
                <div class="flex items-center gap-2 mb-2">
                    <input type="color" value="${cat.color}" onchange="updateCategory('${cat.id}', 'color', this.value)" class="w-8 h-8 rounded border-none p-0 cursor-pointer">
                    <input type="text" value="${cat.name}" onchange="updateCategory('${cat.id}', 'name', this.value)" class="flex-1 bg-transparent border-b border-slate-200 dark:border-slate-700 outline-none text-sm py-1">
                    <button onclick="deleteCategory('${cat.id}')" class="text-slate-400 hover:text-rose-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }
        function addCategory() {
            const newCat = { id: generateId(), name: 'Nova', color: '#6366f1' };
            window.categories.push(newCat);
            updateCategoriesLocalAndCloud();
        }
        function updateCategory(id, field, val) {
            const cat = window.categories.find(c => c.id === id);
            if(cat) {
                const oldName = cat.name;
                cat[field] = val;
                
                if (field === 'name') {
                    // Atualiza tarefas locais que usam essa categoria
                    window.tasks.forEach(t => { if(t.category === oldName) t.category = val; });
                    localStorage.setItem('flowtask_tasks', JSON.stringify(window.tasks));
                }
                
                updateCategoriesLocalAndCloud();
                if(field === 'color') renderBoard();
            }
        }
        function deleteCategory(id) {
            if(confirm("Excluir categoria?")) {
                window.categories = window.categories.filter(c => c.id !== id);
                updateCategoriesLocalAndCloud();
            }
        }
        function updateCategoriesLocalAndCloud() {
            localStorage.setItem('flowtask_categories', JSON.stringify(window.categories));
            renderCategoriesSettings();
            window.saveCategoriesToDB(window.categories);
        }

        // Color Logic Safe
        function setBrandColor(hex) {
            if(!hex.startsWith('#')) hex = '#'+hex;
            const r = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            if(r) {
                const rgb = `${parseInt(r[1], 16)} ${parseInt(r[2], 16)} ${parseInt(r[3], 16)}`;
                document.documentElement.style.setProperty('--c-500', rgb);
                document.documentElement.style.setProperty('--c-600', rgb);
                
                // Safe element checks
                const picker = document.getElementById('brand-picker');
                if(picker) picker.value = hex;
                const text = document.getElementById('brand-hex-input');
                if(text) text.value = hex;
                const prev = document.getElementById('brand-preview');
                if(prev) prev.style.backgroundColor = hex;
                const timerC = document.getElementById('timer-circle');
                if(timerC) timerC.style.stroke = `rgb(${rgb})`;
            }
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }

        function renderBoard() {
            const colTodo = document.getElementById('col-todo');
            const colDoing = document.getElementById('col-doing');
            const colDone = document.getElementById('col-done');
            if (!colTodo) return;

            colTodo.innerHTML = ''; colDoing.innerHTML = ''; colDone.innerHTML = '';
            
            const counts = {todo:0, doing:0, done:0};
            
            // Check if filter exists
            let filter = '';
            const searchInput = document.getElementById('search-input');
            const mobileSearchInput = document.getElementById('mobile-search-input');
            if (searchInput && searchInput.value) filter = searchInput.value.toLowerCase();
            else if (mobileSearchInput && mobileSearchInput.value) filter = mobileSearchInput.value.toLowerCase();

            const sorted = window.tasks
                .filter(t => t.title.toLowerCase().includes(filter))
                .sort((a,b) => a.title.localeCompare(b.title));

            sorted.forEach(t => {
                counts[t.status]++;
                document.getElementById(`col-${t.status}`).appendChild(createCard(t));
            });
            const setSafeText = (id, text) => { const el = document.getElementById(id); if(el) el.innerText = text; };
            setSafeText('count-todo', counts.todo); setSafeText('count-doing', counts.doing); setSafeText('count-done', counts.done);
            
            const total = window.tasks.length;
            const pct = total ? Math.round((counts.done/total)*100) : 0;
            setSafeText('progress-text', `${pct}%`);
            const pBar = document.getElementById('progress-bar');
            if(pBar) pBar.style.width = `${pct}%`;
            
            lucide.createIcons();
        }

        function createCard(t) {
            const d = document.createElement('div');
            const catObj = window.categories.find(c => c.name === t.category) || {color: '#64748b'};
            d.className = `glass-card p-4 mb-3 border-l-4 shadow-sm`;
            d.style.borderLeftColor = catObj.color;
            d.draggable = true;
            d.ondragstart = (e) => e.dataTransfer.setData("text", t.id);

            d.innerHTML = `
                <div class="flex justify-between mb-2">
                    <span class="text-[10px] font-bold px-2 py-1 rounded bg-slate-100 dark:bg-slate-800" style="color:${catObj.color}">${t.category}</span>
                    <div class="flex gap-2">
                        <button onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()" onclick="openPomodoro('${t.id}')" class="text-brand-500"><i data-lucide="play" class="w-4 h-4"></i></button>
                        <button onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()" onclick="openModal('${t.id}')" class="text-slate-400"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                        <button onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()" onclick="requestDelete(event, '${t.id}')" class="text-slate-400 hover:text-rose-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
                <h3 class="font-bold text-sm text-slate-800 dark:text-white mb-1">${t.title}</h3>
                ${t.dueDate ? `<div class="text-xs text-slate-400 flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3"></i> ${t.dueDate}</div>` : ''}
            `;
            return d;
        }

        function fireConfetti() {
            const c = document.getElementById('confetti'); if(!c) return;
            const ctx = c.getContext('2d');
            c.width = window.innerWidth; c.height = window.innerHeight;
            const p = Array.from({length:50}, () => ({ x: Math.random()*c.width, y: -10, color: `hsl(${Math.random()*360},70%,50%)`, speed: Math.random()*5+2 }));
            function step() {
                ctx.clearRect(0,0,c.width,c.height);
                p.forEach(i => { i.y += i.speed; ctx.fillStyle = i.color; ctx.fillRect(i.x, i.y, 6, 6); });
                if(p.some(i => i.y < c.height)) requestAnimationFrame(step);
            }
            step();
        }

        // Pomodoro
        function openPomodoro(id) {
            const t = window.tasks.find(x => x.id === id);
            document.getElementById('pomo-task-title').innerText = t.title;
            document.getElementById('pomodoro-modal').classList.remove('hidden');
        }
        function closePomodoro() { document.getElementById('pomodoro-modal').classList.add('hidden'); stopTimer(); }
        function toggleTimer() { isTimerRunning ? stopTimer() : startTimer(); }
        function startTimer() { 
            isTimerRunning = true; 
            document.getElementById('btn-toggle-timer').innerHTML = '<i data-lucide="pause" class="w-8 h-8 fill-current"></i>';
            lucide.createIcons();
            timerInterval = setInterval(() => {
                if(timeLeft > 0) { timeLeft--; updateTimerDisplay(); } 
                else { stopTimer(); playBeep(); fireConfetti(); }
            }, 1000); 
        }
        function stopTimer() { 
            isTimerRunning = false; clearInterval(timerInterval); 
            document.getElementById('btn-toggle-timer').innerHTML = '<i data-lucide="play" class="w-8 h-8 fill-current"></i>';
            lucide.createIcons();
        }
        function resetTimer() { stopTimer(); timeLeft = 25*60; updateTimerDisplay(); }
        function updateTimerDisplay() {
            const m = Math.floor(timeLeft/60).toString().padStart(2,'0');
            const s = (timeLeft%60).toString().padStart(2,'0');
            document.getElementById('timer-display').innerText = `${m}:${s}`;
        }
        function startTimerEdit() { if(isTimerRunning) stopTimer(); isEditingTimer = true; timerDigits = []; updateTimerEditUI(); const inp = document.getElementById('hidden-timer-input'); inp.value = ''; inp.focus(); document.getElementById('timer-status').innerText = "Digite..."; }
        function handleTimerInput(e) { if(!isEditingTimer) return; const c = e.target.value.slice(-1); if(/[0-9]/.test(c)) { if(timerDigits.length < 4) timerDigits.push(c); } e.target.value = ''; updateTimerEditUI(); if(timerDigits.length === 4) setTimeout(() => document.getElementById('hidden-timer-input').blur(), 300); }
        function finishTimerEdit() { if(!isEditingTimer) return; const m = parseInt((timerDigits[0]||'0') + (timerDigits[1]||'0')); const s = parseInt((timerDigits[2]||'0') + (timerDigits[3]||'0')); const t = m*60 + s; if(t > 0) { initialTime = t; timeLeft = t; } else { initialTime = 25*60; timeLeft = initialTime; } isEditingTimer = false; updateTimerDisplay(); document.getElementById('timer-status').innerText = "Personalizado"; }
        function updateTimerEditUI() { const d = timerDigits; let html = ''; for(let i=0; i<4; i++) { if(i===2) html += '<span class="mx-1 text-white/50 pb-2">:</span>'; html += `<span class="timer-slot ${d.length===i ? 'active' : ''} ${!d[i] ? 'empty' : ''}">${d[i]||'0'}</span>`; } document.getElementById('timer-display').innerHTML = html; }
    </script>
</body>
</html>
